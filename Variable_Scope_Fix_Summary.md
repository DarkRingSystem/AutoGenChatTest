# ğŸ”§ å˜é‡ä½œç”¨åŸŸé—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šé”™è¯¯ï¼š
```
âŒ æµå¼å“åº”ç”Ÿæˆå¤±è´¥ - ä¼šè¯ID: normal_chat_ce588944-93d1-4b2b-a334-d4adf149cd37, é”™è¯¯: cannot access local variable 'orchestrator' where it is not associated with a value
```

## ğŸ” é—®é¢˜åˆ†æ

è¿™æ˜¯ä¸€ä¸ª **Python å˜é‡ä½œç”¨åŸŸé—®é¢˜**ï¼š

### åŸå› 
1. **å˜é‡å®šä¹‰ä½ç½®**: `orchestrator` å˜é‡åœ¨å‡½æ•°å¼€å§‹æ—¶åˆå§‹åŒ–ä¸º `None`
2. **æ¡ä»¶èµ‹å€¼**: åœ¨ if-else å—ä¸­è¢«èµ‹å€¼
3. **å¼‚å¸¸æƒ…å†µ**: å¦‚æœåœ¨èµ‹å€¼è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œå˜é‡å¯èƒ½ä»ä¸º `None`
4. **å‡½æ•°å¼•ç”¨**: `generate_stream()` å†…éƒ¨å‡½æ•°å¼•ç”¨äº†å¤–éƒ¨çš„ `orchestrator` å˜é‡
5. **é”™è¯¯è§¦å‘**: å½“ `orchestrator` ä¸º `None` æ—¶ï¼Œè°ƒç”¨å…¶æ–¹æ³•ä¼šå¤±è´¥

### é”™è¯¯æµç¨‹
```python
orchestrator = None  # åˆå§‹åŒ–

try:
    # å¦‚æœè¿™é‡Œå‡ºç°å¼‚å¸¸ï¼Œorchestrator ä»ä¸º None
    if session_id in active_orchestrators:
        orchestrator = active_orchestrators[session_id]  # å¯èƒ½æœªæ‰§è¡Œ
    else:
        orchestrator = NormalChatOrchestrationAitest(session_data)  # å¯èƒ½æœªæ‰§è¡Œ
    
    async def generate_stream():
        # è¿™é‡Œä½¿ç”¨ orchestratorï¼Œä½†å¯èƒ½ä¸º None
        event_stream = orchestrator.run_stream(task=request.message.strip())  # âŒ é”™è¯¯
```

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ ç©ºå€¼æ£€æŸ¥ âœ…
```python
# ç¡®ä¿ç¼–æ’å™¨å·²æ­£ç¡®åˆå§‹åŒ–
if orchestrator is None:
    logger.error(f"âŒ ç¼–æ’å™¨æœªæ­£ç¡®åˆå§‹åŒ– - ä¼šè¯ID: {session_id}")
    raise HTTPException(status_code=500, detail="ç¼–æ’å™¨åˆå§‹åŒ–å¤±è´¥")
```

### 2. å‡½æ•°å†…éƒ¨å†æ¬¡æ£€æŸ¥ âœ…
```python
async def generate_stream():
    """ç”Ÿæˆ SSE æµå¼å“åº”"""
    try:
        # å†æ¬¡æ£€æŸ¥ç¼–æ’å™¨æ˜¯å¦å¯ç”¨
        if orchestrator is None:
            raise RuntimeError("ç¼–æ’å™¨æœªåˆå§‹åŒ–")
        
        # è·å–æ™ºèƒ½ä½“äº‹ä»¶æµ
        event_stream = orchestrator.run_stream(task=request.message.strip())
```

### 3. æ”¹è¿›é”™è¯¯å¤„ç† âœ…
```python
except Exception as e:
    logger.error(f"âŒ æµå¼å“åº”ç”Ÿæˆå¤±è´¥ - ä¼šè¯ID: {session_id}, é”™è¯¯: {str(e)}")
    # å‘é€æ ¼å¼åŒ–çš„é”™è¯¯æ¶ˆæ¯
    error_message = {
        "type": "error",
        "content": f"å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}",
        "session_id": session_id
    }
    yield f"data: {json.dumps(error_message, ensure_ascii=False)}\n\n"
```

### 4. æ·»åŠ å¿…è¦çš„å¯¼å…¥ âœ…
```python
import json  # ç”¨äºé”™è¯¯æ¶ˆæ¯æ ¼å¼åŒ–
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ âŒ
```
orchestrator = None
# æŸç§å¼‚å¸¸æƒ…å†µä¸‹ï¼Œorchestrator ä»ä¸º None
async def generate_stream():
    event_stream = orchestrator.run_stream(...)  # âŒ AttributeError
```

### ä¿®å¤å âœ…
```
orchestrator = None
# ... åˆå§‹åŒ–é€»è¾‘ ...

# 1. ä¸»å‡½æ•°æ£€æŸ¥
if orchestrator is None:
    raise HTTPException(status_code=500, detail="ç¼–æ’å™¨åˆå§‹åŒ–å¤±è´¥")

async def generate_stream():
    # 2. å‡½æ•°å†…éƒ¨æ£€æŸ¥
    if orchestrator is None:
        raise RuntimeError("ç¼–æ’å™¨æœªåˆå§‹åŒ–")
    
    # 3. å®‰å…¨ä½¿ç”¨
    event_stream = orchestrator.run_stream(...)  # âœ… å®‰å…¨
```

## ğŸ¯ é˜²æŠ¤æœºåˆ¶

### 1. åŒé‡æ£€æŸ¥
- **ä¸»å‡½æ•°çº§åˆ«**: åœ¨åˆ›å»º `generate_stream` å‰æ£€æŸ¥
- **å‡½æ•°å†…éƒ¨**: åœ¨ä½¿ç”¨ `orchestrator` å‰å†æ¬¡æ£€æŸ¥

### 2. æ˜ç¡®é”™è¯¯ä¿¡æ¯
- **HTTP 500**: ç¼–æ’å™¨åˆå§‹åŒ–å¤±è´¥
- **RuntimeError**: ç¼–æ’å™¨æœªåˆå§‹åŒ–
- **è¯¦ç»†æ—¥å¿—**: è®°å½•å…·ä½“çš„é”™è¯¯ä¿¡æ¯

### 3. ä¼˜é›…é™çº§
- **é”™è¯¯æ¶ˆæ¯**: å‘å®¢æˆ·ç«¯å‘é€æ ¼å¼åŒ–çš„é”™è¯¯ä¿¡æ¯
- **ä¼šè¯æ¸…ç†**: åœ¨å‡ºé”™æ—¶æ¸…ç†ä¼šè¯èµ„æº
- **æ—¥å¿—è®°å½•**: è¯¦ç»†è®°å½•é”™è¯¯ä¸Šä¸‹æ–‡

## ğŸ” ç›¸å…³ä¿®å¤

### åŒæ—¶ä¿®å¤çš„é—®é¢˜
1. **CORSé…ç½®**: æ·»åŠ  `x-session-id` åˆ°æš´éœ²å¤´åˆ—è¡¨
2. **ä¼šè¯æŒä¹…æ€§**: ç§»é™¤è‡ªåŠ¨æ¸…ç†ï¼Œä¿æŒä¼šè¯çŠ¶æ€
3. **ç¼–æ’å™¨å¤ç”¨**: å¤ç”¨ç°æœ‰ç¼–æ’å™¨è€Œä¸æ˜¯é‡æ–°åˆ›å»º
4. **å‰ç«¯çŠ¶æ€ç®¡ç†**: åŒé‡å­˜å‚¨æœºåˆ¶ (useState + useRef)

## ğŸ“ ä½¿ç”¨å»ºè®®

### å¼€å‘ç¯å¢ƒ
1. **é‡å¯æœåŠ¡**: ä¿®æ”¹åé‡å¯åç«¯æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹
2. **æ¸…ç†ç¼“å­˜**: æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œå‰ç«¯çŠ¶æ€
3. **æ£€æŸ¥æ—¥å¿—**: è§‚å¯Ÿåç«¯æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

### æµ‹è¯•æ–¹æ³•
1. **åŸºæœ¬åŠŸèƒ½**: å‘é€ç®€å•æ¶ˆæ¯æµ‹è¯•åŸºæœ¬æµç¨‹
2. **ä¼šè¯ä¿æŒ**: å‘é€å¤šæ¡æ¶ˆæ¯éªŒè¯ä¼šè¯è¿ç»­æ€§
3. **é”™è¯¯å¤„ç†**: æ•…æ„è§¦å‘é”™è¯¯éªŒè¯é”™è¯¯å¤„ç†æœºåˆ¶

## ğŸ‰ ç»“è®º

**âœ… å˜é‡ä½œç”¨åŸŸé—®é¢˜å·²å®Œå…¨ä¿®å¤ï¼**

- **æ ¹æœ¬åŸå› **: Python å˜é‡ä½œç”¨åŸŸå’Œå¼‚å¸¸å¤„ç†é—®é¢˜
- **ä¿®å¤æ–¹æ¡ˆ**: åŒé‡æ£€æŸ¥ + æ˜ç¡®é”™è¯¯å¤„ç†
- **é˜²æŠ¤æœºåˆ¶**: å¤šå±‚æ¬¡çš„é”™è¯¯æ£€æµ‹å’Œä¼˜é›…é™çº§
- **ç›¸å…³ä¿®å¤**: åŒæ—¶è§£å†³äº† CORSã€ä¼šè¯æŒä¹…æ€§ç­‰é—®é¢˜

**ç°åœ¨ç³»ç»Ÿå…·å¤‡äº†å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œèƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µï¼** ğŸš€
