"""
æ–‡ä»¶ä¸Šä¸‹æ–‡åŠŸèƒ½ç¤ºä¾‹
æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨æ–‡ä»¶ä¸Šä¸‹æ–‡åŠŸèƒ½ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
"""
import asyncio
import sys
import os

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from api.routes import get_file_storage, _build_message_with_file_context


async def example_1_basic_usage():
    """ç¤ºä¾‹ 1: åŸºæœ¬ä½¿ç”¨"""
    print("\n" + "="*80)
    print("ç¤ºä¾‹ 1: åŸºæœ¬ä½¿ç”¨ - å•ä¸ªæ–‡ä»¶")
    print("="*80)
    
    # è·å–æ–‡ä»¶å­˜å‚¨
    storage = get_file_storage()
    
    # æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ å’Œè§£æï¼ˆå®é™…ä½¿ç”¨ä¸­ï¼Œè¿™äº›æ•°æ®æ¥è‡ª Markdown è½¬æ¢ APIï¼‰
    file_id = "example_file_001"
    storage[file_id] = {
        "filename": "ç™»å½•åŠŸèƒ½éœ€æ±‚.md",
        "markdown": """# ç™»å½•åŠŸèƒ½éœ€æ±‚æ–‡æ¡£

## åŠŸèƒ½æè¿°
ç”¨æˆ·å¯ä»¥é€šè¿‡ç”¨æˆ·åå’Œå¯†ç ç™»å½•ç³»ç»Ÿã€‚

## éªŒæ”¶æ ‡å‡†
1. ç”¨æˆ·è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç‚¹å‡»ç™»å½•æŒ‰é’®ï¼Œç³»ç»ŸéªŒè¯æˆåŠŸåè·³è½¬åˆ°é¦–é¡µ
2. ç”¨æˆ·è¾“å…¥é”™è¯¯çš„ç”¨æˆ·åæˆ–å¯†ç ï¼Œç³»ç»Ÿæ˜¾ç¤ºé”™è¯¯æç¤º
3. ç”¨æˆ·åå’Œå¯†ç è¾“å…¥æ¡†æ”¯æŒå¤åˆ¶ç²˜è´´
4. å¯†ç è¾“å…¥æ¡†æ˜¾ç¤ºä¸ºå¯†æ–‡
5. ç™»å½•æŒ‰é’®åœ¨ç”¨æˆ·åå’Œå¯†ç éƒ½ä¸ä¸ºç©ºæ—¶æ‰å¯ç‚¹å‡»

## ä¸šåŠ¡è§„åˆ™
- ç”¨æˆ·åé•¿åº¦: 3-20 ä¸ªå­—ç¬¦
- å¯†ç é•¿åº¦: 6-20 ä¸ªå­—ç¬¦
- è¿ç»­ç™»å½•å¤±è´¥ 5 æ¬¡åï¼Œè´¦å·é”å®š 30 åˆ†é’Ÿ
""",
        "metadata": {"page_count": 1}
    }
    
    print(f"âœ“ æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ : {storage[file_id]['filename']}")
    print(f"âœ“ æ–‡ä»¶ ID: {file_id}")
    
    # æ„å»ºåŒ…å«æ–‡ä»¶ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯
    user_message = "è¯·æ ¹æ®éœ€æ±‚æ–‡æ¡£ï¼Œç”Ÿæˆç™»å½•åŠŸèƒ½çš„æµ‹è¯•ç”¨ä¾‹"
    message_with_context = _build_message_with_file_context(user_message, [file_id])
    
    print(f"\nğŸ“ å‘é€ç»™å¤§æ¨¡å‹çš„å®Œæ•´æ¶ˆæ¯:")
    print("-" * 80)
    print(message_with_context)
    print("-" * 80)


async def example_2_multiple_files():
    """ç¤ºä¾‹ 2: å¤šä¸ªæ–‡ä»¶"""
    print("\n" + "="*80)
    print("ç¤ºä¾‹ 2: å¤šä¸ªæ–‡ä»¶ - éœ€æ±‚æ–‡æ¡£ + è®¾è®¡æ–‡æ¡£")
    print("="*80)
    
    # è·å–æ–‡ä»¶å­˜å‚¨
    storage = get_file_storage()
    
    # æ·»åŠ éœ€æ±‚æ–‡æ¡£
    file_id_1 = "example_file_002"
    storage[file_id_1] = {
        "filename": "APIç½‘å…³éœ€æ±‚.md",
        "markdown": """# API ç½‘å…³ - åº”ç”¨ç®¡ç†åŠŸèƒ½éœ€æ±‚

## åŠŸèƒ½æè¿°
å¼€å‘è€…å¯ä»¥åˆ›å»ºåº”ç”¨ï¼Œå¹¶ä¸ºåº”ç”¨é…ç½®å¤šç§è®¤è¯æ–¹å¼ã€‚

## åŠŸèƒ½ç‚¹
1. åˆ›å»ºåº”ç”¨ï¼šå¼€å‘è€…å¯ä»¥åˆ›å»ºæ–°åº”ç”¨ï¼Œå¡«å†™åº”ç”¨åç§°ã€æè¿°ç­‰ä¿¡æ¯
2. ç¼–è¾‘åº”ç”¨ï¼šå¼€å‘è€…å¯ä»¥ä¿®æ”¹åº”ç”¨çš„åŸºæœ¬ä¿¡æ¯
3. åˆ é™¤åº”ç”¨ï¼šå¼€å‘è€…å¯ä»¥åˆ é™¤ä¸å†ä½¿ç”¨çš„åº”ç”¨
4. åº”ç”¨åˆ—è¡¨ï¼šå¼€å‘è€…å¯ä»¥æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„æ‰€æœ‰åº”ç”¨

## éªŒæ”¶æ ‡å‡†
- åº”ç”¨åç§°ä¸èƒ½ä¸ºç©ºï¼Œé•¿åº¦ 1-50 ä¸ªå­—ç¬¦
- åº”ç”¨æè¿°å¯é€‰ï¼Œæœ€å¤§é•¿åº¦ 200 ä¸ªå­—ç¬¦
- åˆ é™¤åº”ç”¨æ—¶éœ€è¦äºŒæ¬¡ç¡®è®¤
- åº”ç”¨åˆ—è¡¨æ”¯æŒåˆ†é¡µï¼Œæ¯é¡µæ˜¾ç¤º 10 æ¡è®°å½•
""",
        "metadata": {}
    }
    
    # æ·»åŠ è®¾è®¡æ–‡æ¡£
    file_id_2 = "example_file_003"
    storage[file_id_2] = {
        "filename": "åº”ç”¨ç®¡ç†UIè®¾è®¡.md",
        "markdown": """# åº”ç”¨ç®¡ç† UI è®¾è®¡æ–‡æ¡£

## é¡µé¢å¸ƒå±€
- é¡¶éƒ¨ï¼šæ ‡é¢˜ "æˆ‘çš„åº”ç”¨" + "åˆ›å»ºåº”ç”¨" æŒ‰é’®
- ä¸­é—´ï¼šåº”ç”¨åˆ—è¡¨ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰
- åº•éƒ¨ï¼šåˆ†é¡µæ§ä»¶

## åº”ç”¨åˆ—è¡¨è¡¨æ ¼
| åˆ—å | è¯´æ˜ |
|------|------|
| åº”ç”¨åç§° | æ˜¾ç¤ºåº”ç”¨åç§°ï¼Œå¯ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… |
| åº”ç”¨æè¿° | æ˜¾ç¤ºåº”ç”¨æè¿°ï¼Œè¶…è¿‡ 50 å­—ç¬¦æ˜¾ç¤ºçœç•¥å· |
| åˆ›å»ºæ—¶é—´ | æ˜¾ç¤ºåˆ›å»ºæ—¶é—´ï¼Œæ ¼å¼: YYYY-MM-DD HH:mm:ss |
| æ“ä½œ | ç¼–è¾‘ã€åˆ é™¤æŒ‰é’® |

## åˆ›å»ºåº”ç”¨å¼¹çª—
- åº”ç”¨åç§°è¾“å…¥æ¡†ï¼ˆå¿…å¡«ï¼‰
- åº”ç”¨æè¿°è¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼Œå¤šè¡Œæ–‡æœ¬ï¼‰
- ç¡®å®šã€å–æ¶ˆæŒ‰é’®
""",
        "metadata": {}
    }
    
    print(f"âœ“ æ·»åŠ æ–‡ä»¶ 1: {storage[file_id_1]['filename']}")
    print(f"âœ“ æ·»åŠ æ–‡ä»¶ 2: {storage[file_id_2]['filename']}")
    
    # æ„å»ºåŒ…å«å¤šä¸ªæ–‡ä»¶ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯
    user_message = "è¯·æ ¹æ®éœ€æ±‚æ–‡æ¡£å’Œè®¾è®¡æ–‡æ¡£ï¼Œç”Ÿæˆåº”ç”¨ç®¡ç†åŠŸèƒ½çš„å®Œæ•´æµ‹è¯•ç”¨ä¾‹"
    message_with_context = _build_message_with_file_context(
        user_message, 
        [file_id_1, file_id_2]
    )
    
    print(f"\nğŸ“ å‘é€ç»™å¤§æ¨¡å‹çš„å®Œæ•´æ¶ˆæ¯:")
    print("-" * 80)
    print(message_with_context)
    print("-" * 80)


async def example_3_no_files():
    """ç¤ºä¾‹ 3: ä¸ä½¿ç”¨æ–‡ä»¶ä¸Šä¸‹æ–‡"""
    print("\n" + "="*80)
    print("ç¤ºä¾‹ 3: ä¸ä½¿ç”¨æ–‡ä»¶ä¸Šä¸‹æ–‡")
    print("="*80)
    
    # ä¸ä¼ é€’æ–‡ä»¶ ID
    user_message = "è¯·ç”Ÿæˆä¸€ä¸ªç®€å•çš„ç™»å½•åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹"
    message_with_context = _build_message_with_file_context(user_message, None)
    
    print(f"ğŸ“ åŸå§‹æ¶ˆæ¯: {user_message}")
    print(f"ğŸ“ å¤„ç†åæ¶ˆæ¯: {message_with_context}")
    
    if user_message == message_with_context:
        print("âœ“ æ²¡æœ‰æ–‡ä»¶æ—¶ï¼Œæ¶ˆæ¯ä¿æŒä¸å˜")


async def example_4_file_not_found():
    """ç¤ºä¾‹ 4: æ–‡ä»¶ä¸å­˜åœ¨çš„æƒ…å†µ"""
    print("\n" + "="*80)
    print("ç¤ºä¾‹ 4: æ–‡ä»¶ä¸å­˜åœ¨çš„æƒ…å†µ")
    print("="*80)
    
    # ä¼ é€’ä¸å­˜åœ¨çš„æ–‡ä»¶ ID
    user_message = "è¯·ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹"
    nonexistent_file_ids = ["nonexistent_001", "nonexistent_002"]
    
    print(f"âš ï¸ å°è¯•ä½¿ç”¨ä¸å­˜åœ¨çš„æ–‡ä»¶ ID: {nonexistent_file_ids}")
    
    message_with_context = _build_message_with_file_context(
        user_message, 
        nonexistent_file_ids
    )
    
    if user_message == message_with_context:
        print("âœ“ æ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼Œè¿”å›åŸå§‹æ¶ˆæ¯ï¼ˆä¸ä¼šæŠ¥é”™ï¼‰")


async def main():
    """è¿è¡Œæ‰€æœ‰ç¤ºä¾‹"""
    print("\n" + "="*80)
    print("æ–‡ä»¶ä¸Šä¸‹æ–‡åŠŸèƒ½ç¤ºä¾‹")
    print("="*80)
    
    # è¿è¡Œç¤ºä¾‹
    await example_1_basic_usage()
    await example_2_multiple_files()
    await example_3_no_files()
    await example_4_file_not_found()
    
    print("\n" + "="*80)
    print("ç¤ºä¾‹è¿è¡Œå®Œæˆ")
    print("="*80)
    print("\nğŸ’¡ æç¤º:")
    print("  1. åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæ–‡ä»¶å†…å®¹æ¥è‡ª Markdown è½¬æ¢ API")
    print("  2. æ–‡ä»¶ ID ç”± API è‡ªåŠ¨ç”Ÿæˆå¹¶è¿”å›ç»™å‰ç«¯")
    print("  3. å‰ç«¯åœ¨å‘é€æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆè¯·æ±‚æ—¶ï¼Œæºå¸¦ file_ids å‚æ•°")
    print("  4. åç«¯è‡ªåŠ¨å°†æ–‡ä»¶å†…å®¹æ·»åŠ åˆ°å¤§æ¨¡å‹çš„ä¸Šä¸‹æ–‡ä¸­")
    print("\nğŸ“š ç›¸å…³ API:")
    print("  - POST /api/convert/markdown/batch - æ‰¹é‡è½¬æ¢æ–‡ä»¶ä¸º Markdown")
    print("  - POST /api/team/chat/stream - æµ‹è¯•ç”¨ä¾‹å›¢é˜Ÿæµå¼å¯¹è¯")


if __name__ == "__main__":
    asyncio.run(main())

