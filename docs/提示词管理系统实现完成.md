# 🎉 提示词管理系统实现完成！

## 概述

成功实现了一个集中化的提示词管理系统，将所有智能体的系统提示词从代码中分离出来，统一管理在 `backend/prompts/` 目录中。

---

## ✅ 完成内容

### 1. **目录结构**

```
backend/prompts/
├── README.md                      # 详细使用文档
├── prompt_loader.py               # 提示词加载器
├── assistant.txt                  # 通用助手提示词
├── test_case_generator.txt        # 测试用例生成专家提示词
├── test_case_reviewer.txt         # 测试用例评审专家提示词
└── test_case_optimizer.txt        # 测试用例优化专家提示词
```

### 2. **核心组件**

#### A. 提示词加载器 (`prompt_loader.py`)
- ✅ `PromptLoader` 类：负责加载和管理提示词
- ✅ 支持缓存机制，提高性能
- ✅ 支持热重载，方便开发调试
- ✅ 提供便捷函数 `load_prompt()`
- ✅ 定义提示词名称常量 `PromptNames`

#### B. 提示词文件
- ✅ `assistant.txt`：通用 AI 助手提示词
- ✅ `test_case_generator.txt`：测试用例生成专家（详细版）
- ✅ `test_case_reviewer.txt`：测试用例评审专家（详细版）
- ✅ `test_case_optimizer.txt`：测试用例优化专家（详细版）

#### C. 代码集成
- ✅ 修改 `backend/services/ai_service.py`
- ✅ 导入提示词加载器
- ✅ 使用 `load_prompt()` 加载提示词
- ✅ 替换所有硬编码的提示词

---

## 🎯 设计优势

### 1. **集中管理**
- 所有提示词集中在一个目录
- 便于查找和修改
- 避免提示词散落在代码各处

### 2. **易于维护**
- 修改提示词不需要改动代码
- 支持版本控制（Git）
- 可以快速迭代优化

### 3. **可读性强**
- 使用纯文本文件，易于阅读
- 支持多行格式，便于组织复杂提示词
- 可以添加 Markdown 格式的注释和说明

### 4. **灵活性高**
- 支持热重载（开发模式）
- 支持缓存（生产模式）
- 可以动态切换不同的提示词

### 5. **类型安全**
- 使用 `PromptNames` 常量避免拼写错误
- IDE 自动补全支持
- 编译时检查

---

## 📝 使用方法

### 1. **在代码中加载提示词**

```python
from prompts.prompt_loader import load_prompt, PromptNames

# 方式 1: 使用便捷函数 + 常量（推荐）
system_message = load_prompt(PromptNames.TEST_CASE_GENERATOR)

# 方式 2: 使用字符串
system_message = load_prompt("test_case_generator")

# 方式 3: 使用加载器实例
from prompts.prompt_loader import get_prompt_loader

loader = get_prompt_loader()
system_message = loader.load("test_case_generator")
```

### 2. **在智能体中使用**

```python
from autogen_agentchat.agents import AssistantAgent
from prompts.prompt_loader import load_prompt, PromptNames

# 创建智能体
agent = AssistantAgent(
    name="TestCase_Generator",
    model_client=model_client,
    system_message=load_prompt(PromptNames.TEST_CASE_GENERATOR),
    model_client_stream=True,
)
```

### 3. **修改提示词**

```bash
# 1. 编辑提示词文件
vim backend/prompts/test_case_generator.txt

# 2. 保存文件

# 3. 重启服务（或使用热重载）
```

### 4. **开发模式：热重载**

```python
from prompts.prompt_loader import get_prompt_loader

loader = get_prompt_loader()

# 重新加载单个提示词
system_message = loader.reload("test_case_generator")

# 清除所有缓存
loader.clear_cache()
```

---

## 📋 提示词列表

| 文件名 | 常量名 | 智能体 | 用途 |
|--------|--------|--------|------|
| `assistant.txt` | `PromptNames.ASSISTANT` | Assistant | 通用 AI 助手 |
| `test_case_generator.txt` | `PromptNames.TEST_CASE_GENERATOR` | TestCase_Generator | 生成测试用例 |
| `test_case_reviewer.txt` | `PromptNames.TEST_CASE_REVIEWER` | TestCase_Reviewer | 评审测试用例 |
| `test_case_optimizer.txt` | `PromptNames.TEST_CASE_OPTIMIZER` | TestCase_Optimizer | 优化测试用例 |

---

## 🔧 核心功能

### 1. **PromptLoader 类**

```python
class PromptLoader:
    def __init__(self, prompts_dir: Optional[str] = None)
    def load(self, prompt_name: str, use_cache: bool = True) -> str
    def reload(self, prompt_name: str) -> str
    def clear_cache(self) -> None
    def list_prompts(self) -> list[str]
    def get_prompt_path(self, prompt_name: str) -> Path
```

### 2. **便捷函数**

```python
# 获取全局加载器实例
loader = get_prompt_loader()

# 加载提示词
prompt = load_prompt("test_case_generator")
```

### 3. **提示词名称常量**

```python
class PromptNames:
    ASSISTANT = "assistant"
    TEST_CASE_GENERATOR = "test_case_generator"
    TEST_CASE_REVIEWER = "test_case_reviewer"
    TEST_CASE_OPTIMIZER = "test_case_optimizer"
```

---

## 📊 提示词内容对比

### 修改前（硬编码在代码中）

```python
system_message = "你是一个测试用例生成专家，负责根据需求生成全面、详细的测试用例。请确保测试用例覆盖正常场景、边界条件和异常情况。"
```

**问题**：
- ❌ 提示词太简单
- ❌ 修改需要改代码
- ❌ 难以维护和优化
- ❌ 没有版本控制

### 修改后（从文件加载）

```python
system_message = load_prompt(PromptNames.TEST_CASE_GENERATOR)
```

**文件内容** (`test_case_generator.txt`)：
```
你是一个测试用例生成专家，负责根据需求生成全面、详细的测试用例。

## 职责
- 分析功能需求，识别测试场景
- 生成覆盖全面的测试用例
- 确保测试用例包含正常场景、边界条件和异常情况
- 使用清晰的表格格式组织测试用例

## 测试用例格式
每个测试用例应包含：
- 用例编号
- 测试场景描述
- 前提条件
- 输入数据
- 操作步骤
- 预期结果

## 覆盖范围
- ✅ 正常场景（Happy Path）
- ✅ 边界条件（Boundary Conditions）
- ✅ 异常情况（Error Handling）
- ✅ 安全性测试（Security）
- ✅ 性能测试（Performance）
- ✅ 兼容性测试（Compatibility）
- ✅ 用户体验测试（UX）

请生成结构化、易于理解和执行的测试用例。
```

**优势**：
- ✅ 提示词更详细、更专业
- ✅ 修改只需编辑文本文件
- ✅ 易于维护和优化
- ✅ 支持版本控制
- ✅ 使用 Markdown 格式，可读性强

---

## 🚀 高级功能

### 1. **自定义提示词目录**

```python
from prompts.prompt_loader import PromptLoader

# 使用自定义目录
loader = PromptLoader("/path/to/custom/prompts")
system_message = loader.load("custom_prompt")
```

### 2. **禁用缓存（开发模式）**

```python
# 每次都从文件读取，方便调试
system_message = loader.load("test_case_generator", use_cache=False)
```

### 3. **列出所有可用提示词**

```python
from prompts.prompt_loader import get_prompt_loader

loader = get_prompt_loader()
prompts = loader.list_prompts()
print(f"可用提示词: {prompts}")
# 输出: ['assistant', 'test_case_generator', 'test_case_optimizer', 'test_case_reviewer']
```

### 4. **获取提示词文件路径**

```python
path = loader.get_prompt_path("test_case_generator")
print(f"提示词文件路径: {path}")
# 输出: /path/to/backend/prompts/test_case_generator.txt
```

---

## 📚 最佳实践

### 1. **编写提示词**

#### ✅ 好的提示词
```
你是一个[角色名称]，负责[主要职责]。

## 职责
- 职责 1
- 职责 2

## 输出格式
- 格式要求 1
- 格式要求 2

## 注意事项
- 注意事项 1
- 注意事项 2
```

#### ❌ 不好的提示词
```
你是一个专家，请帮我做事情。
```

### 2. **使用 Markdown 格式**
- 使用标题组织内容（`##`、`###`）
- 使用列表展示要点（`-`、`1.`）
- 使用加粗强调重点（`**重点**`）
- 使用代码块展示示例（` ``` `）

### 3. **版本控制**

```bash
# 提交提示词修改
git add backend/prompts/test_case_generator.txt
git commit -m "优化测试用例生成器提示词：增加安全性测试要求"

# 查看修改历史
git log backend/prompts/test_case_generator.txt

# 比较不同版本
git diff HEAD~1 backend/prompts/test_case_generator.txt
```

### 4. **迭代优化**
1. 从简单的提示词开始
2. 根据实际效果逐步优化
3. 记录每次修改的原因和效果
4. 进行 A/B 测试对比

---

## 🔍 故障排查

### 问题 1: 提示词文件不存在

```
FileNotFoundError: 提示词文件不存在: /path/to/prompts/xxx.txt
```

**解决方案**：
- 检查文件名是否正确
- 确认文件是否存在于 `backend/prompts/` 目录
- 检查文件扩展名是否为 `.txt`

### 问题 2: 导入错误

```
ModuleNotFoundError: No module named 'prompts'
```

**解决方案**：
- 确认 `backend/prompts/` 目录存在
- 确认 `prompt_loader.py` 文件存在
- 检查 Python 路径配置

### 问题 3: 缓存未更新

**解决方案**：
```python
# 清除缓存并重新加载
from prompts.prompt_loader import get_prompt_loader

loader = get_prompt_loader()
loader.clear_cache()
system_message = loader.load("test_case_generator")
```

---

## 📈 性能优化

### 1. **缓存机制**
- 默认启用缓存，避免重复读取文件
- 首次加载后，后续调用直接从内存读取
- 显著提高性能

### 2. **懒加载**
- 只在需要时加载提示词
- 不会一次性加载所有提示词
- 减少内存占用

### 3. **单例模式**
- 全局共享一个 `PromptLoader` 实例
- 避免重复创建加载器
- 共享缓存，提高效率

---

## 🎨 未来扩展

### 1. **多语言支持**
```
prompts/
├── zh/
│   ├── assistant.txt
│   └── test_case_generator.txt
└── en/
    ├── assistant.txt
    └── test_case_generator.txt
```

### 2. **环境变量配置**
```python
# 根据环境加载不同的提示词
loader = PromptLoader(os.getenv("PROMPTS_DIR", "backend/prompts"))
```

### 3. **提示词模板**
```python
# 支持变量替换
template = load_prompt("template")
prompt = template.format(role="测试专家", task="生成测试用例")
```

### 4. **提示词验证**
```python
# 验证提示词格式和内容
validator = PromptValidator()
validator.validate("test_case_generator")
```

---

## 📖 相关文档

- **使用文档**: `backend/prompts/README.md`
- **提示词文件**: `backend/prompts/*.txt`
- **加载器代码**: `backend/prompts/prompt_loader.py`
- **服务代码**: `backend/services/ai_service.py`

---

**提示词管理系统实现完成！现在可以轻松管理和优化所有智能体的提示词了！** 🎉📝✨

**快速开始**：
1. 查看 `backend/prompts/README.md` 了解详细用法
2. 编辑 `backend/prompts/*.txt` 文件优化提示词
3. 重启服务查看效果
4. 使用 Git 管理提示词版本

