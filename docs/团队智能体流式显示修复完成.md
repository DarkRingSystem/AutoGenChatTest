# ğŸ‰ å›¢é˜Ÿæ™ºèƒ½ä½“æµå¼æ˜¾ç¤ºä¿®å¤å®Œæˆï¼

## é—®é¢˜æè¿°

ç”¨æˆ·åˆ‡æ¢åˆ°å›¢é˜Ÿæ¨¡å¼åï¼Œå‰ç«¯å‘é€æ¶ˆæ¯ï¼Œä½†åç«¯æ²¡æœ‰è¿”å›ä¿¡æ¯ã€‚

## é—®é¢˜åŸå› 

åœ¨ `backend/api/routes.py` ä¸­ï¼Œ`/api/team-chat/stream` ç«¯ç‚¹å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

### 1. **å‚æ•°åé”™è¯¯**
```python
# âŒ é”™è¯¯
async for event in team_service.run_stream(task=request.message):
    yield event

# âœ… æ­£ç¡®
async for event in team_service.run_stream(message=request.message):
    yield event
```

`TestCasesTeamAIService.run_stream()` æ–¹æ³•çš„å‚æ•°åæ˜¯ `message`ï¼Œä¸æ˜¯ `task`ã€‚

### 2. **èµ„æºè¿‡æ—©æ¸…ç†**
```python
# âŒ é”™è¯¯ - finally å—åœ¨ StreamingResponse è¿”å›åç«‹å³æ‰§è¡Œ
try:
    # åˆå§‹åŒ–å›¢é˜Ÿ
    await team_service.initialize()
    
    # åˆ›å»ºæµ
    sse_stream = team_stream_service.process_stream(...)
    
    return StreamingResponse(sse_stream, ...)
finally:
    # âš ï¸ è¿™é‡Œä¼šåœ¨æµå¼€å§‹ä¹‹å‰å°±æ¸…ç†èµ„æºï¼
    await team_service.cleanup()
```

`finally` å—åœ¨ `StreamingResponse` è¿”å›åç«‹å³æ‰§è¡Œï¼Œå¯¼è‡´å›¢é˜Ÿèµ„æºåœ¨æµå¼ä¼ è¾“å¼€å§‹ä¹‹å‰å°±è¢«æ¸…ç†äº†ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. **ä¿®å¤å‚æ•°å**
å°† `task=request.message` æ”¹ä¸º `message=request.message`

### 2. **å»¶è¿Ÿèµ„æºæ¸…ç†**
å°†æ¸…ç†é€»è¾‘ç§»åˆ°æµç»“æŸåæ‰§è¡Œï¼š

```python
# âœ… æ­£ç¡® - åœ¨æµç»“æŸåæ¸…ç†èµ„æº
async def get_event_stream_with_cleanup():
    try:
        async for event in team_service.run_stream(message=request.message):
            yield event
    finally:
        # åœ¨æµç»“æŸåæ¸…ç†å›¢é˜Ÿèµ„æº
        await team_service.cleanup()
        print("ğŸ§¹ å›¢é˜Ÿæµç»“æŸï¼Œèµ„æºå·²æ¸…ç†")

sse_stream = team_stream_service.process_stream(get_event_stream_with_cleanup(), request.message)

return StreamingResponse(sse_stream, ...)
```

---

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. **backend/api/routes.py**
- âœ… ä¿®å¤å‚æ•°åï¼š`task` â†’ `message`
- âœ… ç§»é™¤å¤–å±‚ `try-finally` å—
- âœ… åœ¨å†…éƒ¨ç”Ÿæˆå™¨ä¸­æ·»åŠ  `try-finally` å—
- âœ… èµ„æºæ¸…ç†å»¶è¿Ÿåˆ°æµç»“æŸå

### 2. **backend/services/team_stream_service.py**
- âœ… ç§»é™¤æ‰€æœ‰è°ƒè¯•æ—¥å¿—ï¼ˆ`print` è¯­å¥ï¼‰
- âœ… ä¿ç•™æ ¸å¿ƒæµå¼å¤„ç†é€»è¾‘

### 3. **backend/test_team_stream.py** (æ–°å¢)
- âœ… åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯å›¢é˜Ÿæµå¼æœåŠ¡
- âœ… ä¿®å¤å‚æ•°åï¼š`task` â†’ `message`

---

## æµ‹è¯•ç»“æœ

### æµ‹è¯•å‘½ä»¤
```bash
cd backend && python3 test_team_stream.py
```

### æµ‹è¯•è¾“å‡º
```
ğŸ§ª å¼€å§‹æµ‹è¯•å›¢é˜Ÿæµå¼æœåŠ¡...
âœ… å›¢é˜Ÿåˆå§‹åŒ–æˆåŠŸ

ğŸ“ æµ‹è¯•æ¶ˆæ¯: ä¸ºç”¨æˆ·ç™»å½•åŠŸèƒ½ç”Ÿæˆç®€å•çš„æµ‹è¯•ç”¨ä¾‹

ğŸ“¨ SSE æ¶ˆæ¯ #1: status - å›¢é˜Ÿåä½œä¸­...
ğŸ“¨ SSE æ¶ˆæ¯ #2: agent_start - TestCase_Generator
ğŸ“¨ SSE æ¶ˆæ¯ #3-600+: agent_message - TestCase_Generator (æµå¼è¾“å‡º)
ğŸ“¨ SSE æ¶ˆæ¯ #601: agent_done - TestCase_Generator
ğŸ“¨ SSE æ¶ˆæ¯ #602: agent_start - TestCase_Reviewer
ğŸ“¨ SSE æ¶ˆæ¯ #603-1340+: agent_message - TestCase_Reviewer (æµå¼è¾“å‡º)
ğŸ“¨ SSE æ¶ˆæ¯ #1341: agent_done - TestCase_Reviewer
ğŸ“¨ SSE æ¶ˆæ¯ #1342: tokens - {total: 1638, input: 11, output: 1627}
ğŸ“¨ SSE æ¶ˆæ¯ #1343: done
ğŸ“¨ SSE æ¶ˆæ¯ #1344: [DONE]

âœ… æµ‹è¯•å®Œæˆï¼å…±æ”¶åˆ° 1344 æ¡ SSE æ¶ˆæ¯
```

### æµ‹è¯•ç»“æœåˆ†æ

âœ… **æˆåŠŸï¼** æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼š

1. âœ… **TestCase_Generator** æ™ºèƒ½ä½“æ­£å¸¸å·¥ä½œå¹¶æµå¼è¾“å‡º
2. âœ… **TestCase_Reviewer** æ™ºèƒ½ä½“æ­£å¸¸å·¥ä½œå¹¶æµå¼è¾“å‡º
3. âœ… æ™ºèƒ½ä½“åˆ‡æ¢æ£€æµ‹æ­£å¸¸ï¼ˆGenerator â†’ Reviewerï¼‰
4. âœ… Reviewer è¯´äº† "APPROVE"ï¼Œè§¦å‘ç»ˆæ­¢æ¡ä»¶
5. âœ… Token ç»Ÿè®¡æ­£å¸¸ï¼ˆè¾“å…¥11ï¼Œè¾“å‡º1627ï¼Œæ€»è®¡1638ï¼‰
6. âœ… èµ„æºåœ¨æµç»“æŸåæ­£ç¡®æ¸…ç†

**æ³¨æ„**ï¼šåªæœ‰ 2 ä¸ªæ™ºèƒ½ä½“å·¥ä½œï¼ˆGenerator å’Œ Reviewerï¼‰ï¼Œæ²¡æœ‰ Optimizerã€‚è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸º Reviewer ç›´æ¥æ‰¹å‡†äº†ï¼ˆè¯´äº† "APPROVE"ï¼‰ï¼Œæ‰€ä»¥ä¸éœ€è¦ Optimizer ä¼˜åŒ–ã€‚

---

## åŠŸèƒ½éªŒè¯

### åç«¯éªŒè¯ âœ…
- âœ… å›¢é˜Ÿåˆå§‹åŒ–æˆåŠŸ
- âœ… 3 ä¸ªæ™ºèƒ½ä½“åˆ›å»ºæˆåŠŸ
- âœ… æµå¼äº‹ä»¶æ­£å¸¸ç”Ÿæˆ
- âœ… æ™ºèƒ½ä½“åˆ‡æ¢æ­£å¸¸
- âœ… Token ç»Ÿè®¡æ­£å¸¸
- âœ… èµ„æºæ¸…ç†æ­£å¸¸

### å‰ç«¯éªŒè¯ ğŸ”„
ç°åœ¨å¯ä»¥åœ¨å‰ç«¯æµ‹è¯•ï¼š

1. æ‰“å¼€ http://localhost:3000
2. ç‚¹å‡» Header ä¸­çš„å›¢é˜Ÿå›¾æ ‡ ğŸ‘¥
3. å‘é€æ¶ˆæ¯ï¼š"ä¸ºç”¨æˆ·ç™»å½•åŠŸèƒ½ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹"
4. è§‚å¯Ÿï¼š
   - âœ… çœ‹åˆ° "å›¢é˜Ÿåä½œä¸­..." çŠ¶æ€
   - âœ… çœ‹åˆ° TestCase_Generator æ™ºèƒ½ä½“å¡ç‰‡
   - âœ… çœ‹åˆ°æµå¼æ–‡æœ¬é€å­—è¾“å‡º
   - âœ… çœ‹åˆ° TestCase_Reviewer æ™ºèƒ½ä½“å¡ç‰‡
   - âœ… çœ‹åˆ°æµå¼æ–‡æœ¬é€å­—è¾“å‡º
   - âœ… å¯ä»¥æŠ˜å /å±•å¼€æ¯ä¸ªæ™ºèƒ½ä½“çš„å›å¤

---

## æ ¸å¿ƒä»£ç 

### backend/api/routes.py
```python
@router.post("/api/team-chat/stream")
async def team_chat_stream(request: ChatRequest):
    """æµ‹è¯•ç”¨ä¾‹å›¢é˜Ÿæ¨¡å¼çš„æµå¼èŠå¤©å“åº”"""
    if not request.message:
        raise HTTPException(status_code=400, detail="æ¶ˆæ¯ä¸èƒ½ä¸ºç©º")
    
    from services.ai_service import TestCasesTeamAIService
    from services.team_stream_service import TeamStreamService
    from config import settings
    
    # åˆ›å»ºå›¢é˜ŸæœåŠ¡å®ä¾‹
    team_service = TestCasesTeamAIService(settings)
    
    # åˆå§‹åŒ–å›¢é˜Ÿ
    await team_service.initialize()
    
    # åˆ›å»ºå›¢é˜ŸæµæœåŠ¡
    team_stream_service = TeamStreamService()
    
    # ä»å›¢é˜Ÿè·å–äº‹ä»¶æµï¼Œå¹¶åœ¨æµç»“æŸåæ¸…ç†èµ„æº
    async def get_event_stream_with_cleanup():
        try:
            async for event in team_service.run_stream(message=request.message):
                yield event
        finally:
            # åœ¨æµç»“æŸåæ¸…ç†å›¢é˜Ÿèµ„æº
            await team_service.cleanup()
            print("ğŸ§¹ å›¢é˜Ÿæµç»“æŸï¼Œèµ„æºå·²æ¸…ç†")
    
    # å¤„ç†æµå¼å“åº”ï¼ˆä½¿ç”¨å›¢é˜ŸæµæœåŠ¡ï¼‰
    sse_stream = team_stream_service.process_stream(
        get_event_stream_with_cleanup(), 
        request.message
    )
    
    return StreamingResponse(
        sse_stream,
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "X-Accel-Buffering": "no",
            "X-Team-Mode": "true",
        }
    )
```

---

## äº‹ä»¶æµç¨‹

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
åç«¯åˆå§‹åŒ–å›¢é˜Ÿ
    â†“
å‘é€ status: "å›¢é˜Ÿåä½œä¸­..."
    â†“
TestCase_Generator å¼€å§‹å·¥ä½œ
    â†“
å‘é€ agent_start: TestCase_Generator
    â†“
æµå¼è¾“å‡ºæµ‹è¯•ç”¨ä¾‹
    â†“
å‘é€å¤šä¸ª agent_message: TestCase_Generator
    â†“
TestCase_Generator å®Œæˆ
    â†“
å‘é€ agent_done: TestCase_Generator
    â†“
TestCase_Reviewer å¼€å§‹å·¥ä½œ
    â†“
å‘é€ agent_start: TestCase_Reviewer
    â†“
æµå¼è¾“å‡ºè¯„å®¡æ„è§
    â†“
å‘é€å¤šä¸ª agent_message: TestCase_Reviewer
    â†“
TestCase_Reviewer è¯´ "APPROVE"
    â†“
å‘é€ agent_done: TestCase_Reviewer
    â†“
å‘é€ tokens: {total, input, output}
    â†“
å‘é€ done
    â†“
å‘é€ [DONE]
    â†“
æ¸…ç†å›¢é˜Ÿèµ„æº
```

---

## æ™ºèƒ½ä½“è§’è‰²

| æ™ºèƒ½ä½“åç§° | è§’è‰² | èŒè´£ |
|-----------|------|------|
| TestCase_Generator | ğŸ¯ æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆä¸“å®¶ | ç”Ÿæˆè¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹ |
| TestCase_Reviewer | ğŸ” æµ‹è¯•ç”¨ä¾‹è¯„å®¡ä¸“å®¶ | è¯„å®¡æµ‹è¯•ç”¨ä¾‹è´¨é‡ |
| TestCase_Optimizer | âœ¨ æµ‹è¯•ç”¨ä¾‹ä¼˜åŒ–ä¸“å®¶ | ä¼˜åŒ–æµ‹è¯•ç”¨ä¾‹ï¼ˆå¦‚æœéœ€è¦ï¼‰ |

---

## ç»ˆæ­¢æ¡ä»¶

å›¢é˜Ÿåä½œåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ç»ˆæ­¢ï¼š

1. **Reviewer æ‰¹å‡†**ï¼šReviewer è¯´ "APPROVE"
2. **è¾¾åˆ°æœ€å¤§æ¶ˆæ¯æ•°**ï¼šè¶…è¿‡ 20 æ¡æ¶ˆæ¯ï¼ˆMaxMessageTerminationï¼‰

---

## ä¸‹ä¸€æ­¥

ç°åœ¨å¯ä»¥åœ¨å‰ç«¯æµ‹è¯•å›¢é˜Ÿæ¨¡å¼äº†ï¼

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ‰“å¼€ http://localhost:3000
2. ç‚¹å‡» Header ä¸­çš„å›¢é˜Ÿå›¾æ ‡ ğŸ‘¥
3. å‘é€æ¶ˆæ¯ï¼š"ä¸ºç”¨æˆ·ç™»å½•åŠŸèƒ½ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹"
4. è§‚å¯Ÿ 3 ä¸ªæ™ºèƒ½ä½“çš„åä½œè¿‡ç¨‹
5. æµ‹è¯•æŠ˜å /å±•å¼€åŠŸèƒ½

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… çœ‹åˆ° TestCase_Generator ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
- âœ… çœ‹åˆ° TestCase_Reviewer è¯„å®¡æµ‹è¯•ç”¨ä¾‹
- âœ… æ¯ä¸ªæ™ºèƒ½ä½“çš„å›å¤éƒ½å¯ä»¥ç‹¬ç«‹æŠ˜å /å±•å¼€
- âœ… æµå¼æ–‡æœ¬é€å­—æ˜¾ç¤º
- âœ… Token ç»Ÿè®¡æ˜¾ç¤ºåœ¨åº•éƒ¨

---

**æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼å›¢é˜Ÿæ™ºèƒ½ä½“æµå¼æ˜¾ç¤ºåŠŸèƒ½ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼** ğŸ‰ğŸ¤–âœ¨

