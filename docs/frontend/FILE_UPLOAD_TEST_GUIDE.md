# 文件上传功能测试指南

## 🧪 测试准备

### 1. 启动服务

#### 后端服务
```bash
# 终端 1
cd backend
source .venv/bin/activate  # 如果使用虚拟环境
python main.py
```

后端应该运行在 http://localhost:8000

#### 前端服务
```bash
# 终端 2
cd frontend
npm run dev
```

前端应该运行在 http://localhost:3002（或其他可用端口）

### 2. 准备测试文件

准备以下测试文件：
- 1 个小 PDF 文件（< 10MB）
- 1 个图片文件（.png 或 .jpg）
- 1 个 Word 文档（.docx）
- 1 个大文件（> 100MB，用于测试大小限制）
- 1 个不支持的文件（.txt，用于测试格式限制）

## 📋 测试用例

### 测试用例 1: 基本上传和解析

**目标**: 验证单个文件上传和解析功能

**步骤**:
1. 打开浏览器访问 http://localhost:3002
2. 选择"普通对话"模式
3. 在文件上传区域点击或拖拽上传一个 PDF 文件
4. 验证文件出现在文件列表中
5. 点击"开始解析"按钮
6. 观察解析进度条
7. 等待解析完成

**预期结果**:
- ✅ 文件成功上传并显示在列表中
- ✅ 显示文件名和文件大小
- ✅ 解析过程中显示进度条
- ✅ 解析完成后显示 ✅ 图标和"已解析"标签
- ✅ 输入框提示变为"已加载 1 个文件，输入问题..."
- ✅ 显示成功消息："成功解析 1 个文件"

---

### 测试用例 2: 多文件上传

**目标**: 验证多文件上传和批量解析功能

**步骤**:
1. 上传 3 个不同格式的文件（PDF, PNG, DOCX）
2. 验证所有文件都显示在列表中
3. 点击"开始解析"按钮
4. 等待解析完成

**预期结果**:
- ✅ 所有文件都成功上传
- ✅ 文件列表显示"已选择 3 个文件"
- ✅ 解析完成后所有文件都显示 ✅ 图标
- ✅ 输入框提示变为"已加载 3 个文件，输入问题..."
- ✅ 显示成功消息："成功解析 3 个文件"

---

### 测试用例 3: 文件大小限制

**目标**: 验证 100MB 文件大小限制

**步骤**:
1. 尝试上传一个超过 100MB 的文件
2. 观察错误提示

**预期结果**:
- ✅ 显示错误消息："文件 xxx 超过 100MB 限制"
- ✅ 文件不会被添加到列表中

---

### 测试用例 4: 文件数量限制

**目标**: 验证 10 个文件数量限制

**步骤**:
1. 尝试一次性上传 11 个文件
2. 观察错误提示

**预期结果**:
- ✅ 显示错误消息："最多只能上传 10 个文件"
- ✅ 只有前 10 个文件被添加到列表中

---

### 测试用例 5: 不支持的文件格式

**目标**: 验证文件格式限制

**步骤**:
1. 尝试上传一个 .txt 文件
2. 观察错误提示

**预期结果**:
- ✅ 显示错误消息："不支持的文件格式: xxx.txt"
- ✅ 文件不会被添加到列表中

---

### 测试用例 6: 文件移除

**目标**: 验证文件移除功能

**步骤**:
1. 上传 2 个文件
2. 点击其中一个文件的删除按钮
3. 验证文件被移除

**预期结果**:
- ✅ 文件从列表中消失
- ✅ 文件计数更新："已选择 1 个文件"

---

### 测试用例 7: 解析中状态

**目标**: 验证解析过程中的状态控制

**步骤**:
1. 上传一个文件
2. 点击"开始解析"
3. 在解析过程中尝试：
   - 输入消息
   - 上传新文件
   - 删除文件

**预期结果**:
- ✅ 输入框显示"正在解析文件，请稍候..."
- ✅ 输入框被禁用
- ✅ 文件上传被禁用
- ✅ 删除按钮被禁用
- ✅ 显示解析进度条

---

### 测试用例 8: 上下文集成

**目标**: 验证文件内容作为上下文发送

**步骤**:
1. 上传并解析一个 PDF 文件
2. 输入问题："总结一下文件内容"
3. 发送消息
4. 观察用户消息和智能体回复

**预期结果**:
- ✅ 用户消息显示文件标记："📎 包含 1 个文件"
- ✅ 智能体能够基于文件内容回答问题
- ✅ 回复内容与文件相关

---

### 测试用例 9: 多文件上下文

**目标**: 验证多个文件的上下文集成

**步骤**:
1. 上传并解析 3 个文件
2. 输入问题："对比这几个文件的内容"
3. 发送消息
4. 观察智能体回复

**预期结果**:
- ✅ 用户消息显示："📎 包含 3 个文件"
- ✅ 智能体能够对比多个文件的内容
- ✅ 回复涉及所有文件

---

### 测试用例 10: 解析失败处理

**目标**: 验证解析失败的错误处理

**步骤**:
1. 上传一个损坏的 PDF 文件（如果有）
2. 点击"开始解析"
3. 观察解析结果

**预期结果**:
- ✅ 失败的文件显示 ❌ 图标
- ✅ 显示"解析失败"标签
- ✅ 显示错误信息
- ✅ 成功的文件仍然可用

---

### 测试用例 11: 主题切换

**目标**: 验证深色/浅色主题适配

**步骤**:
1. 上传文件
2. 切换主题（点击右上角主题切换按钮）
3. 观察文件上传区域的样式

**预期结果**:
- ✅ 深色主题下样式正确
- ✅ 浅色主题下样式正确
- ✅ 文件列表在两种主题下都清晰可读

---

### 测试用例 12: 测试用例智能体模式

**目标**: 验证在测试用例智能体模式下的文件上传

**步骤**:
1. 选择"测试用例智能体"模式
2. 上传并解析文件
3. 输入问题并发送
4. 观察智能体团队的回复

**预期结果**:
- ✅ 文件上传功能正常
- ✅ 文件内容作为上下文发送
- ✅ 智能体团队能够基于文件内容协作回答

---

### 测试用例 13: 清空对话后的文件状态

**目标**: 验证清空对话后文件状态

**步骤**:
1. 上传并解析文件
2. 发送一条消息
3. 点击"清空对话"按钮
4. 观察文件状态

**预期结果**:
- ✅ 对话被清空
- ✅ 文件仍然保留在列表中
- ✅ 可以继续使用已解析的文件

---

### 测试用例 14: 响应式设计

**目标**: 验证移动端适配

**步骤**:
1. 调整浏览器窗口大小到移动端尺寸
2. 上传文件
3. 观察布局

**预期结果**:
- ✅ 文件上传区域适配移动端
- ✅ 文件列表在小屏幕上正常显示
- ✅ 按钮和操作在移动端可用

---

## 🐛 常见问题排查

### 问题 1: 文件上传后没有反应

**可能原因**:
- 后端服务未启动
- 端口被占用

**解决方法**:
```bash
# 检查后端服务
curl http://localhost:8000/health

# 检查端口占用
lsof -i :8000
```

---

### 问题 2: 解析失败

**可能原因**:
- 文件损坏
- 文件格式不支持
- marker 库未安装

**解决方法**:
```bash
# 检查依赖
pip list | grep marker

# 重新安装
pip install marker-pdf
```

---

### 问题 3: 前端样式错误

**可能原因**:
- CSS 文件未加载
- 组件导入错误

**解决方法**:
```bash
# 重启前端服务
cd frontend
npm run dev
```

---

### 问题 4: 文件上下文未生效

**可能原因**:
- 文件未解析成功
- 解析结果为空

**解决方法**:
- 检查浏览器控制台错误
- 检查后端日志
- 验证文件内容是否正确

---

## 📊 测试检查清单

使用以下清单确保所有功能都已测试：

- [ ] 单个文件上传
- [ ] 多个文件上传
- [ ] 文件大小限制（100MB）
- [ ] 文件数量限制（10个）
- [ ] 文件格式限制
- [ ] 文件移除
- [ ] 解析进度显示
- [ ] 解析成功状态
- [ ] 解析失败处理
- [ ] 输入框状态控制
- [ ] 文件上下文集成
- [ ] 用户消息文件标记
- [ ] 深色主题适配
- [ ] 浅色主题适配
- [ ] 普通对话模式
- [ ] 测试用例智能体模式
- [ ] 响应式设计

---

## 🎯 性能测试

### 测试场景 1: 小文件批量上传
- 上传 10 个小文件（每个 < 1MB）
- 记录解析时间
- 预期：< 30 秒

### 测试场景 2: 大文件上传
- 上传 1 个大文件（50-100MB）
- 记录解析时间
- 预期：< 2 分钟

### 测试场景 3: 混合文件上传
- 上传 5 个不同格式的文件
- 记录解析时间
- 预期：< 1 分钟

---

## ✅ 测试完成标准

所有测试用例通过后，功能即可认为已完成并可投入使用。

如有任何问题，请查看：
- 浏览器控制台错误
- 后端日志
- 网络请求详情
- `FILE_UPLOAD_FEATURE_SUMMARY.md` 文档

