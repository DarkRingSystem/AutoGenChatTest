# ğŸ”’ ä¼šè¯éš”ç¦»å®ç°å®Œæˆï¼

## âœ… é—®é¢˜è§£å†³

æˆ‘å·²ç»æˆåŠŸå®ç°äº†**ä¼šè¯éš”ç¦»**åŠŸèƒ½ï¼Œç°åœ¨æ¯ä¸ªç”¨æˆ·/çº¿ç¨‹éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„ AI æ™ºèƒ½ä½“ï¼Œäº’ä¸å¹²æ‰°ï¼

---

## ğŸ¯ é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜ âŒ
```
ç”¨æˆ· A: ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰
AI: ä½ å¥½å¼ ä¸‰ï¼

ç”¨æˆ· B: æˆ‘æ˜¯è°ï¼Ÿ
AI: ä½ æ˜¯å¼ ä¸‰ï¼  â† é”™è¯¯ï¼ä¼šè¯æ··æ·†
```

**åŸå› **ï¼š
- æ‰€æœ‰ç”¨æˆ·å…±äº«åŒä¸€ä¸ª AI æ™ºèƒ½ä½“å®ä¾‹
- æ™ºèƒ½ä½“ä¿ç•™äº†æ‰€æœ‰ç”¨æˆ·çš„å¯¹è¯å†å²
- å¤šä¸ªä¼šè¯äº’ç›¸å¹²æ‰°

### è§£å†³æ–¹æ¡ˆ âœ…
```
ç”¨æˆ· A (ä¼šè¯ 1): ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰
AI: ä½ å¥½å¼ ä¸‰ï¼

ç”¨æˆ· B (ä¼šè¯ 2): æˆ‘æ˜¯è°ï¼Ÿ
AI: æˆ‘ä¸çŸ¥é“ä½ çš„åå­—ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚  â† æ­£ç¡®ï¼ä¼šè¯éš”ç¦»
```

**å®ç°**ï¼š
- æ¯ä¸ªä¼šè¯æ‹¥æœ‰ç‹¬ç«‹çš„ AI æ™ºèƒ½ä½“å®ä¾‹
- ä¼šè¯é€šè¿‡ `conversation_id` åŒºåˆ†
- è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†ä¼šè¯

---

## ğŸ—ï¸ æ¶æ„æ”¹è¿›

### æ–°å¢æ¨¡å—

#### 1. **SessionService** - ä¼šè¯ç®¡ç†æœåŠ¡

```python
class SessionService:
    """ä¼šè¯ç®¡ç†æœåŠ¡ç±»"""
    
    async def get_or_create_session(session_id)  # è·å–æˆ–åˆ›å»ºä¼šè¯
    async def get_session(session_id)            # è·å–ä¼šè¯
    async def delete_session(session_id)         # åˆ é™¤ä¼šè¯
    async def list_sessions()                    # åˆ—å‡ºæ‰€æœ‰ä¼šè¯
    async def get_session_info(session_id)       # è·å–ä¼šè¯ä¿¡æ¯
```

#### 2. **Session** - ä¼šè¯ç±»

```python
class Session:
    """ä¼šè¯ç±»ï¼Œè¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„ AI å¯¹è¯ä¼šè¯"""
    
    session_id: str           # ä¼šè¯ ID
    agent: AssistantAgent     # ç‹¬ç«‹çš„ AI æ™ºèƒ½ä½“
    created_at: datetime      # åˆ›å»ºæ—¶é—´
    last_accessed: datetime   # æœ€åè®¿é—®æ—¶é—´
    message_count: int        # æ¶ˆæ¯è®¡æ•°
```

---

## ğŸ”‘ æ ¸å¿ƒç‰¹æ€§

### 1. **ä¼šè¯éš”ç¦»** ğŸ”’

æ¯ä¸ª `conversation_id` å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„æ™ºèƒ½ä½“ï¼š

```python
# ä¼šè¯ 1
session_1 = await session_service.get_or_create_session("conv_123")
# session_1.agent æ˜¯ç‹¬ç«‹çš„æ™ºèƒ½ä½“

# ä¼šè¯ 2
session_2 = await session_service.get_or_create_session("conv_456")
# session_2.agent æ˜¯å¦ä¸€ä¸ªç‹¬ç«‹çš„æ™ºèƒ½ä½“
```

### 2. **è‡ªåŠ¨ä¼šè¯ç®¡ç†** ğŸ¤–

- **è‡ªåŠ¨åˆ›å»º**ï¼šé¦–æ¬¡è®¿é—®æ—¶è‡ªåŠ¨åˆ›å»ºä¼šè¯
- **è‡ªåŠ¨æ¸…ç†**ï¼š30 åˆ†é’Ÿæ— æ´»åŠ¨è‡ªåŠ¨æ¸…ç†
- **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨ asyncio.Lock ä¿è¯å¹¶å‘å®‰å…¨

### 3. **ä¼šè¯è¿½è¸ª** ğŸ“Š

æ¯ä¸ªä¼šè¯è®°å½•ï¼š
- åˆ›å»ºæ—¶é—´
- æœ€åè®¿é—®æ—¶é—´
- æ¶ˆæ¯æ•°é‡
- ä¼šè¯ ID

### 4. **èµ„æºä¼˜åŒ–** âš¡

- **å…±äº«æ¨¡å‹å®¢æˆ·ç«¯**ï¼šæ‰€æœ‰ä¼šè¯å…±äº«åŒä¸€ä¸ª API å®¢æˆ·ç«¯
- **ç‹¬ç«‹æ™ºèƒ½ä½“**ï¼šæ¯ä¸ªä¼šè¯æœ‰ç‹¬ç«‹çš„å¯¹è¯å†å²
- **å®šæœŸæ¸…ç†**ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯ï¼Œé‡Šæ”¾å†…å­˜

---

## ğŸ“¡ API ä½¿ç”¨

### 1. **æµå¼èŠå¤©**ï¼ˆè‡ªåŠ¨ä¼šè¯ç®¡ç†ï¼‰

```bash
# ç¬¬ä¸€æ¬¡è¯·æ±‚ - è‡ªåŠ¨åˆ›å»ºä¼šè¯
curl -X POST http://localhost:8000/api/chat/stream \
  -H "Content-Type: application/json" \
  -d '{
    "message": "ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰",
    "conversation_id": "user_001"
  }'

# å“åº”å¤´åŒ…å«ä¼šè¯ ID
# X-Session-ID: user_001

# ç¬¬äºŒæ¬¡è¯·æ±‚ - ä½¿ç”¨ç›¸åŒä¼šè¯
curl -X POST http://localhost:8000/api/chat/stream \
  -H "Content-Type: application/json" \
  -d '{
    "message": "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ",
    "conversation_id": "user_001"
  }'

# AI ä¼šè®°ä½ï¼šä½ å«å¼ ä¸‰
```

### 2. **éæµå¼èŠå¤©**

```bash
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "ä½ å¥½",
    "conversation_id": "user_002"
  }'
```

### 3. **åˆ—å‡ºæ‰€æœ‰ä¼šè¯**

```bash
curl http://localhost:8000/api/sessions

# å“åº”
{
  "sessions": [
    {
      "session_id": "user_001",
      "created_at": "2025-10-03T10:00:00",
      "last_accessed": "2025-10-03T10:05:00",
      "message_count": 5
    },
    {
      "session_id": "user_002",
      "created_at": "2025-10-03T10:02:00",
      "last_accessed": "2025-10-03T10:03:00",
      "message_count": 2
    }
  ],
  "total": 2
}
```

### 4. **è·å–ä¼šè¯ä¿¡æ¯**

```bash
curl http://localhost:8000/api/sessions/user_001

# å“åº”
{
  "session_id": "user_001",
  "created_at": "2025-10-03T10:00:00",
  "last_accessed": "2025-10-03T10:05:00",
  "message_count": 5
}
```

### 5. **åˆ é™¤ä¼šè¯**

```bash
curl -X DELETE http://localhost:8000/api/sessions/user_001

# å“åº”
{
  "message": "ä¼šè¯å·²åˆ é™¤",
  "session_id": "user_001"
}
```

### 6. **å¥åº·æ£€æŸ¥**ï¼ˆåŒ…å«ä¼šè¯æ•°ï¼‰

```bash
curl http://localhost:8000/health

# å“åº”
{
  "status": "healthy",
  "agent_initialized": true,
  "session_count": 5
}
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### ä¼šè¯åˆ›å»ºæµç¨‹

```
1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ˆå¸¦ conversation_idï¼‰
   â†“
2. SessionService.get_or_create_session()
   â†“
3. æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨
   â”œâ”€ å­˜åœ¨ â†’ è¿”å›ç°æœ‰ä¼šè¯
   â””â”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°ä¼šè¯
       â†“
       åˆ›å»ºç‹¬ç«‹çš„ AssistantAgent
       â†“
       ä¿å­˜åˆ°ä¼šè¯å­—å…¸
       â†“
       è¿”å›æ–°ä¼šè¯
   â†“
4. ä½¿ç”¨ä¼šè¯çš„æ™ºèƒ½ä½“å¤„ç†æ¶ˆæ¯
   â†“
5. æ›´æ–°ä¼šè¯è®¿é—®æ—¶é—´å’Œæ¶ˆæ¯è®¡æ•°
```

### ä¼šè¯æ¸…ç†æµç¨‹

```
å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰
   â†“
æ£€æŸ¥æ‰€æœ‰ä¼šè¯
   â†“
æ‰¾å‡ºè¿‡æœŸä¼šè¯ï¼ˆ30 åˆ†é’Ÿæ— æ´»åŠ¨ï¼‰
   â†“
åˆ é™¤è¿‡æœŸä¼šè¯
   â†“
é‡Šæ”¾å†…å­˜
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯é›†æˆ

```javascript
// ä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆå”¯ä¸€çš„ä¼šè¯ ID
const conversationId = `user_${userId}`;

// å‘é€æ¶ˆæ¯æ—¶å¸¦ä¸Šä¼šè¯ ID
const response = await fetch('http://localhost:8000/api/chat/stream', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    message: userInput,
    conversation_id: conversationId  // å…³é”®ï¼
  })
});

// ä»å“åº”å¤´è·å–ä¼šè¯ ID
const sessionId = response.headers.get('X-Session-ID');
console.log('ä¼šè¯ ID:', sessionId);
```

### å¤šç”¨æˆ·åœºæ™¯

```javascript
// ç”¨æˆ· A çš„ä¼šè¯
const userA_session = 'user_alice';

// ç”¨æˆ· B çš„ä¼šè¯
const userB_session = 'user_bob';

// ç”¨æˆ· A çš„å¯¹è¯
await chat('ä½ å¥½ï¼Œæˆ‘å« Alice', userA_session);
await chat('æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ', userA_session);  // AI: ä½ å« Alice

// ç”¨æˆ· B çš„å¯¹è¯
await chat('ä½ å¥½ï¼Œæˆ‘å« Bob', userB_session);
await chat('æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ', userB_session);  // AI: ä½ å« Bob

// ä¸¤ä¸ªä¼šè¯å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ï¼
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. **å…±äº«æ¨¡å‹å®¢æˆ·ç«¯**

æ‰€æœ‰ä¼šè¯å…±äº«åŒä¸€ä¸ª `OpenAIChatCompletionClient`ï¼š
- âœ… å‡å°‘ API è¿æ¥æ•°
- âœ… é™ä½å†…å­˜å ç”¨
- âœ… æé«˜æ€§èƒ½

### 2. **å¼‚æ­¥é”**

ä½¿ç”¨ `asyncio.Lock` ä¿è¯å¹¶å‘å®‰å…¨ï¼š
- âœ… é˜²æ­¢ç«æ€æ¡ä»¶
- âœ… ä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… æ”¯æŒé«˜å¹¶å‘

### 3. **è‡ªåŠ¨æ¸…ç†**

å®šæœŸæ¸…ç†è¿‡æœŸä¼šè¯ï¼š
- âœ… é‡Šæ”¾å†…å­˜
- âœ… é˜²æ­¢å†…å­˜æ³„æ¼
- âœ… ä¿æŒç³»ç»Ÿå¥åº·

---

## ğŸ¯ é…ç½®é€‰é¡¹

### ä¼šè¯è¶…æ—¶æ—¶é—´

åœ¨ `session_service.py` ä¸­ä¿®æ”¹ï¼š

```python
# é»˜è®¤ 30 åˆ†é’Ÿ
def is_expired(self, timeout_minutes: int = 30) -> bool:
    ...

# ä¿®æ”¹ä¸º 60 åˆ†é’Ÿ
def is_expired(self, timeout_minutes: int = 60) -> bool:
    ...
```

### æ¸…ç†é¢‘ç‡

åœ¨ `session_service.py` ä¸­ä¿®æ”¹ï¼š

```python
# é»˜è®¤æ¯ 5 åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
await asyncio.sleep(300)

# ä¿®æ”¹ä¸ºæ¯ 10 åˆ†é’Ÿ
await asyncio.sleep(600)
```

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: ä¼šè¯éš”ç¦»

```bash
# ä¼šè¯ 1
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "æˆ‘å«å¼ ä¸‰", "conversation_id": "test_1"}'

curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "æˆ‘å«ä»€ä¹ˆï¼Ÿ", "conversation_id": "test_1"}'
# å“åº”: ä½ å«å¼ ä¸‰

# ä¼šè¯ 2
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "æˆ‘å«ä»€ä¹ˆï¼Ÿ", "conversation_id": "test_2"}'
# å“åº”: æˆ‘ä¸çŸ¥é“ä½ çš„åå­—
```

### æµ‹è¯• 2: ä¼šè¯ç®¡ç†

```bash
# åˆ—å‡ºä¼šè¯
curl http://localhost:8000/api/sessions

# æŸ¥çœ‹ä¼šè¯ä¿¡æ¯
curl http://localhost:8000/api/sessions/test_1

# åˆ é™¤ä¼šè¯
curl -X DELETE http://localhost:8000/api/sessions/test_1
```

---

## ğŸŠ æ”¹è¿›æ€»ç»“

| ç‰¹æ€§ | æ”¹è¿›å‰ | æ”¹è¿›å |
|------|--------|--------|
| **ä¼šè¯éš”ç¦»** | âŒ æ‰€æœ‰ç”¨æˆ·å…±äº« | âœ… æ¯ä¸ªä¼šè¯ç‹¬ç«‹ |
| **å¹¶å‘æ”¯æŒ** | âŒ ä¼šè¯æ··æ·† | âœ… å®Œå…¨éš”ç¦» |
| **å†…å­˜ç®¡ç†** | âŒ æ— æ¸…ç†æœºåˆ¶ | âœ… è‡ªåŠ¨æ¸…ç† |
| **ä¼šè¯è¿½è¸ª** | âŒ æ— æ³•è¿½è¸ª | âœ… å®Œæ•´è¿½è¸ª |
| **API ç®¡ç†** | âŒ æ— ä¼šè¯ API | âœ… å®Œæ•´ API |

---

## ğŸš€ å½“å‰çŠ¶æ€

### æœåŠ¡çŠ¶æ€
- âœ… åç«¯å·²æ›´æ–°å¹¶è¿è¡Œ
- âœ… ä¼šè¯éš”ç¦»å·²å®ç°
- âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

### è®¿é—®åœ°å€
- **å‰ç«¯**: http://localhost:3000
- **åç«¯**: http://localhost:8000
- **API æ–‡æ¡£**: http://localhost:8000/docs

### æ–°å¢ API
- `GET /api/sessions` - åˆ—å‡ºæ‰€æœ‰ä¼šè¯
- `GET /api/sessions/{session_id}` - è·å–ä¼šè¯ä¿¡æ¯
- `DELETE /api/sessions/{session_id}` - åˆ é™¤ä¼šè¯
- `GET /health` - å¥åº·æ£€æŸ¥ï¼ˆåŒ…å«ä¼šè¯æ•°ï¼‰

---

**ä¼šè¯éš”ç¦»å·²å®Œæˆï¼ç°åœ¨å¤šä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œäº’ä¸å¹²æ‰°ï¼** ğŸ‰ğŸ”’

