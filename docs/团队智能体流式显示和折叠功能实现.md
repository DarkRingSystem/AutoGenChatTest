# 🎉 团队智能体流式显示和折叠功能实现完成！

## ✅ 完成内容

实现了 3 个智能体的流式返回，并在前端显示每个智能体的名称和角色，支持折叠/展开功能。

---

## 🎯 功能特性

### 1. **智能体流式返回**
- ✅ 3 个智能体都以流式方式返回内容
- ✅ 实时显示每个智能体的工作进度
- ✅ 支持流式文本块更新

### 2. **智能体信息显示**
- ✅ 显示智能体角色（带 emoji）
  - 🎯 测试用例生成专家
  - 🔍 测试用例评审专家
  - ✨ 测试用例优化专家
- ✅ 显示智能体名称（技术名称）
- ✅ 区分不同智能体的回复

### 3. **折叠/展开功能**
- ✅ 每个智能体的回复可以独立折叠
- ✅ 点击智能体头部切换折叠状态
- ✅ 平滑的折叠/展开动画
- ✅ 折叠图标旋转动画

---

## 📁 修改的文件

### 1. **backend/models.py**

#### 扩展 SSEMessage 模型
```python
class SSEMessage(BaseModel):
    """SSE 消息模型"""
    type: Literal[
        "status", "chunk", "message", "tool_call", "tool_result", 
        "done", "error", "tokens", 
        "agent_start", "agent_message", "agent_done"  # ✅ 新增智能体事件类型
    ]
    content: str | dict | list
    tokens: Optional[TokenUsage] = Field(None, description="Token 使用统计")
    agent_name: Optional[str] = Field(None, description="智能体名称")  # ✅ 新增
    agent_role: Optional[str] = Field(None, description="智能体角色")  # ✅ 新增
```

---

### 2. **backend/services/team_stream_service.py** (新文件)

#### 团队流式处理服务
```python
class TeamStreamService:
    """团队流式处理服务类"""

    # 智能体角色映射
    AGENT_ROLES = {
        "TestCase_Generator": "🎯 测试用例生成专家",
        "TestCase_Reviewer": "🔍 测试用例评审专家",
        "TestCase_Optimizer": "✨ 测试用例优化专家",
    }
```

#### 核心功能

**1. 处理智能体切换**
```python
async def _handle_text_message(self, event: Any, source: str):
    # 检测智能体切换
    if source != self.current_agent and source != 'unknown':
        # 发送上一个智能体的完成消息
        if self.current_agent:
            yield self._create_agent_done_message(self.current_agent)
        
        # 切换到新智能体
        self.current_agent = source
        
        # 发送新智能体的开始消息
        yield self._create_agent_start_message(source)
```

**2. 流式文本块处理**
```python
async def _handle_streaming_chunk(self, event: Any, source: str):
    chunk_content = getattr(event, 'content', '')
    
    # 累积智能体响应
    self.agent_responses[source] += chunk_content
    
    # 发送流式块
    message = SSEMessage(
        type="agent_message",
        content=chunk_content,
        agent_name=source,
        agent_role=self.AGENT_ROLES.get(source, source)
    )
    yield message.to_sse_format()
```

**3. Token 统计**
```python
def _create_token_message(self):
    # 计算所有智能体响应的总 token
    all_responses = "\n\n".join(self.agent_responses.values())
    input_tokens = self.token_counter.count_tokens(self.user_message)
    output_tokens = self.token_counter.count_tokens(all_responses)
```

---

### 3. **backend/api/routes.py**

#### 使用团队流服务
```python
@router.post("/api/team-chat/stream")
async def team_chat_stream(request: ChatRequest):
    from services.ai_service import TestCasesTeamAIService
    from services.team_stream_service import TeamStreamService  # ✅ 导入团队流服务
    
    team_service = TestCasesTeamAIService(settings)
    await team_service.initialize()
    
    # 创建团队流服务
    team_stream_service = TeamStreamService()  # ✅ 使用专用流服务
    
    # 处理流式响应
    sse_stream = team_stream_service.process_stream(
        get_event_stream(), 
        request.message
    )
```

---

### 4. **frontend/src/App.jsx**

#### 新增状态管理
```javascript
const [isTeamMode, setIsTeamMode] = useState(false);
const [collapsedAgents, setCollapsedAgents] = useState({}); // ✅ 管理折叠状态
```

#### 消息结构扩展
```javascript
const assistantMsg = {
  id: assistantMsgId,
  role: 'assistant',
  content: '',
  streaming: true,
  tokens: null,
  isTeamMode: isTeamMode,  // ✅ 标记团队模式
  agents: isTeamMode ? [] : undefined,  // ✅ 智能体列表
};
```

#### SSE 事件处理
```javascript
// 智能体开始工作
if (parsed.type === 'agent_start') {
  setMessages(prev =>
    prev.map(msg =>
      msg.id === assistantMsgId
        ? {
            ...msg,
            agents: [
              ...(msg.agents || []),
              {
                name: parsed.agent_name,
                role: parsed.agent_role,
                content: '',
                collapsed: false,
              }
            ]
          }
        : msg
    )
  );
}

// 智能体消息更新
else if (parsed.type === 'agent_message') {
  setMessages(prev =>
    prev.map(msg => {
      if (msg.id === assistantMsgId && msg.agents) {
        const updatedAgents = [...msg.agents];
        const agentIndex = updatedAgents.findIndex(a => a.name === parsed.agent_name);
        if (agentIndex !== -1) {
          updatedAgents[agentIndex] = {
            ...updatedAgents[agentIndex],
            content: updatedAgents[agentIndex].content + parsed.content
          };
        }
        return { ...msg, agents: updatedAgents };
      }
      return msg;
    })
  );
}

// 智能体完成工作
else if (parsed.type === 'agent_done') {
  // 标记智能体完成
}
```

#### 折叠切换函数
```javascript
const toggleAgentCollapse = (messageId, agentName) => {
  setCollapsedAgents(prev => ({
    ...prev,
    [messageId]: {
      ...(prev[messageId] || {}),
      [agentName]: !(prev[messageId]?.[agentName] || false)
    }
  }));
};
```

#### 智能体显示组件
```jsx
{msg.isTeamMode && msg.agents && msg.agents.length > 0 ? (
  <div className="team-agents-container">
    {msg.agents.map((agent, agentIndex) => {
      const isCollapsed = collapsedAgents[msg.id]?.[agent.name] || false;
      return (
        <motion.div key={agentIndex} className="agent-section">
          {/* 智能体头部 - 可点击折叠 */}
          <div 
            className="agent-header"
            onClick={() => toggleAgentCollapse(msg.id, agent.name)}
          >
            <div className="agent-info">
              <span className="agent-role">{agent.role}</span>
              <span className="agent-name">{agent.name}</span>
            </div>
            <motion.div
              className="collapse-icon"
              animate={{ rotate: isCollapsed ? 0 : 180 }}
            >
              ▼
            </motion.div>
          </div>
          
          {/* 智能体内容 - 可折叠 */}
          <AnimatePresence>
            {!isCollapsed && (
              <motion.div
                className="agent-content"
                initial={{ height: 0, opacity: 0 }}
                animate={{ height: 'auto', opacity: 1 }}
                exit={{ height: 0, opacity: 0 }}
              >
                <ReactMarkdown>{agent.content}</ReactMarkdown>
              </motion.div>
            )}
          </AnimatePresence>
        </motion.div>
      );
    })}
  </div>
) : (
  /* 普通模式显示 */
)}
```

---

### 5. **frontend/src/App.css**

#### 智能体容器样式
```css
.team-agents-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 100%;
}

.agent-section {
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.03);
  transition: all 0.3s ease;
}

.agent-section:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.15);
}
```

#### 智能体头部样式
```css
.agent-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  cursor: pointer;
  user-select: none;
  background: rgba(255, 255, 255, 0.05);
  transition: all 0.2s ease;
}

.agent-role {
  font-size: 15px;
  font-weight: 600;
  color: #52c41a;  /* 绿色 */
}

.agent-name {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.5);
  font-family: 'Monaco', 'Courier New', monospace;
}

.collapse-icon {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.4);
  transition: transform 0.3s ease;
}
```

#### 智能体内容样式
```css
.agent-content {
  padding: 0 18px 18px 18px;
  overflow: hidden;
}
```

---

## 🎨 UI 效果

### 团队模式消息显示

```
┌─────────────────────────────────────────┐
│ 🤖 AI 助手                              │
│                                         │
│ ┌─────────────────────────────────┐   │
│ │ 🎯 测试用例生成专家          ▼ │   │
│ │ TestCase_Generator              │   │
│ ├─────────────────────────────────┤   │
│ │ ## 测试用例                     │   │
│ │ 1. 正常登录测试...              │   │
│ │ 2. 错误密码测试...              │   │
│ └─────────────────────────────────┘   │
│                                         │
│ ┌─────────────────────────────────┐   │
│ │ 🔍 测试用例评审专家          ▲ │   │
│ │ TestCase_Reviewer               │   │
│ └─────────────────────────────────┘   │
│   (已折叠)                              │
│                                         │
│ ┌─────────────────────────────────┐   │
│ │ ✨ 测试用例优化专家          ▼ │   │
│ │ TestCase_Optimizer              │   │
│ ├─────────────────────────────────┤   │
│ │ ## 优化后的测试用例             │   │
│ │ 1. 正常登录测试（优化）...      │   │
│ └─────────────────────────────────┘   │
│                                         │
│ Tokens: ↓1234                           │
└─────────────────────────────────────────┘
```

---

## 🔄 工作流程

### 后端流程

```
1. 用户发送消息
   ↓
2. TestCasesTeamAIService 初始化
   ↓
3. RoundRobinGroupChat 开始协作
   ↓
4. TestCase_Generator 生成测试用例
   → 发送 agent_start 事件
   → 流式发送 agent_message 事件
   → 发送 agent_done 事件
   ↓
5. TestCase_Reviewer 评审测试用例
   → 发送 agent_start 事件
   → 流式发送 agent_message 事件
   → 发送 agent_done 事件
   ↓
6. TestCase_Optimizer 优化测试用例
   → 发送 agent_start 事件
   → 流式发送 agent_message 事件
   → 发送 agent_done 事件
   ↓
7. 发送 tokens 事件
   ↓
8. 发送 done 事件
```

### 前端流程

```
1. 接收 agent_start 事件
   → 在 agents 数组中添加新智能体
   → 显示智能体头部
   ↓
2. 接收 agent_message 事件
   → 更新对应智能体的 content
   → 流式显示内容
   ↓
3. 接收 agent_done 事件
   → 标记智能体完成
   → 停止显示光标
   ↓
4. 用户点击智能体头部
   → 切换折叠状态
   → 播放折叠/展开动画
```

---

## 📊 事件类型

| 事件类型 | 说明 | 数据 |
|---------|------|------|
| `agent_start` | 智能体开始工作 | `agent_name`, `agent_role` |
| `agent_message` | 智能体消息更新 | `agent_name`, `agent_role`, `content` |
| `agent_done` | 智能体完成工作 | `agent_name`, `agent_role`, `content` |
| `tokens` | Token 统计 | `tokens: {total, input, output}` |
| `done` | 全部完成 | - |

---

## 🎯 使用示例

### 1. 启动服务
```bash
# 后端
cd backend && python3 main.py

# 前端
cd frontend && npm run dev
```

### 2. 切换到团队模式
1. 打开 http://localhost:3000
2. 点击 Header 中的团队图标 👥
3. 按钮变为绿色 + 显示徽章

### 3. 生成测试用例
1. 点击建议："🔐 为用户登录功能生成测试用例"
2. 观察 3 个智能体依次工作：
   - 🎯 生成专家：生成初步测试用例
   - 🔍 评审专家：评审并提供反馈
   - ✨ 优化专家：根据反馈优化

### 4. 折叠/展开智能体
1. 点击智能体头部
2. 观察平滑的折叠/展开动画
3. 折叠图标旋转 180°

---

## 💡 技术亮点

### 1. **流式处理**
- 使用 SSE (Server-Sent Events)
- 实时更新智能体内容
- 低延迟，高响应

### 2. **状态管理**
- 独立管理每个智能体的折叠状态
- 支持多消息、多智能体

### 3. **动画效果**
- Framer Motion 提供平滑动画
- 折叠/展开过渡自然
- 图标旋转动画

### 4. **用户体验**
- 清晰的智能体角色标识
- 可折叠减少视觉干扰
- 流式显示提供实时反馈

---

## 🚀 后续优化建议

1. **智能体头像**
   - 为每个智能体添加独特的图标
   - 使用不同颜色区分

2. **进度指示**
   - 显示当前工作的智能体
   - 添加进度条

3. **智能体统计**
   - 显示每个智能体的 token 使用
   - 显示响应时间

4. **默认折叠**
   - 除最后一个智能体外，其他默认折叠
   - 减少初始视觉负担

---

**团队智能体流式显示和折叠功能实现完成！** 🎉🤖

