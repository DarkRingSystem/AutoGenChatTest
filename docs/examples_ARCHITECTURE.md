# UI 图片分析智能体团队 - 架构文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层 (User Layer)                       │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  单图片分析   │  │  流式分析     │  │  批量分析     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   API 层 (ImageAnalyzerTeam)                     │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  initialize()        - 初始化团队                         │  │
│  │  analyze_image()     - 分析图片                           │  │
│  │  analyze_image_stream() - 流式分析                        │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                  智能体层 (Agent Layer)                          │
│                                                                  │
│  ┌─────────────┐  ┌──────────────────┐  ┌─────────────────┐   │
│  │  UI 专家     │  │  交互分析师       │  │  测试场景专家    │   │
│  │             │  │                  │  │                 │   │
│  │ • 视觉分析   │  │ • 交互行为分析    │  │ • 综合分析       │   │
│  │ • 布局分析   │  │ • 用户流程分析    │  │ • 场景设计       │   │
│  │ • 元素识别   │  │ • 测试点识别      │  │ • 脚本建议       │   │
│  └─────────────┘  └──────────────────┘  └─────────────────┘   │
│         │                  │                      │             │
│         │                  │                      │             │
│         └────────┬─────────┘                      │             │
│                  │                                │             │
│         ┌────────▼────────┐                       │             │
│         │   GraphFlow     │◄──────────────────────┘             │
│         │  (并行工作流)    │                                     │
│         │                 │                                     │
│         │ • UI_Expert 和  │                                     │
│         │   Interaction   │                                     │
│         │   _Analyst 并行 │                                     │
│         │ • 结果汇总到    │                                     │
│         │   Test_Scenario │                                     │
│         │   _Expert       │                                     │
│         └─────────────────┘                                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                  模型层 (Model Layer)                            │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              llms.py - 模型客户端管理                      │  │
│  │                                                            │  │
│  │  ┌─────────────────┐  ┌─────────────────┐               │  │
│  │  │ Vision Model    │  │ UI-TARS Model   │               │  │
│  │  │ (图像理解)       │  │ (UI 自动化)      │               │  │
│  │  └─────────────────┘  └─────────────────┘               │  │
│  │                                                            │  │
│  │  • 客户端缓存                                              │  │
│  │  • 模型家族识别                                            │  │
│  │  • 配置管理                                                │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                  配置层 (Configuration Layer)                    │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  config.py - 配置管理                                      │  │
│  │                                                            │  │
│  │  • API 配置                                                │  │
│  │  • 模型配置 (默认/视觉/UI-TARS)                             │  │
│  │  • 服务器配置                                              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  prompts/ - 提示词管理                                     │  │
│  │                                                            │  │
│  │  • ui_expert.txt                                          │  │
│  │  • interaction_analyst.txt                                │  │
│  │  • test_scenario_expert.txt                               │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流图

```
┌──────────────┐
│  用户输入     │
│ • 图片路径    │
│ • 用户需求    │
└──────┬───────┘
       │
       ▼
┌──────────────────────┐
│  任务消息构建         │
│ _build_task_message() │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│         团队协作分析                  │
│                                      │
│  UI 专家 → 交互分析师 → 测试场景专家  │
│                                      │
│  (RoundRobinGroupChat)               │
└──────┬───────────────────────────────┘
       │
       ▼
┌──────────────────────┐
│  结果解析             │
│ _parse_analysis_results()│
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  结构化输出           │
│ • ui_analysis        │
│ • interaction_analysis│
│ • test_scenarios     │
│ • chat_history       │
│ • summary            │
└──────────────────────┘
```

## 模块依赖关系

```
image_analyzer.py
    │
    ├─→ llms.py
    │   └─→ config.py
    │
    ├─→ prompts/prompt_loader.py
    │   └─→ prompts/*.txt
    │
    └─→ autogen_agentchat
        ├─→ agents.AssistantAgent
        ├─→ teams.RoundRobinGroupChat
        └─→ conditions.*
```

## 类图

```
┌─────────────────────────────────────┐
│      ImageAnalyzerTeam              │
├─────────────────────────────────────┤
│ - settings: Settings                │
│ - vision_model_client: Client       │
│ - agents: List[AssistantAgent]      │
│ - team: RoundRobinGroupChat         │
├─────────────────────────────────────┤
│ + initialize() -> None              │
│ + analyze_image() -> Dict           │
│ + analyze_image_stream() -> Stream  │
│ + is_initialized() -> bool          │
│ + get_team() -> RoundRobinGroupChat │
├─────────────────────────────────────┤
│ - _create_team_members() -> None    │
│ - _create_team() -> None            │
│ - _build_task_message() -> str      │
│ - _parse_analysis_results() -> Dict │
│ - _generate_summary() -> str        │
└─────────────────────────────────────┘
```

## 时序图

```
用户          ImageAnalyzerTeam    UI专家    交互分析师    测试场景专家
 │                  │                │          │              │
 │ analyze_image()  │                │          │              │
 ├─────────────────>│                │          │              │
 │                  │                │          │              │
 │                  │ 构建任务消息    │          │              │
 │                  │────────────────┤          │              │
 │                  │                │          │              │
 │                  │ 分析 UI        │          │              │
 │                  │───────────────>│          │              │
 │                  │                │          │              │
 │                  │    UI 分析结果  │          │              │
 │                  │<───────────────│          │              │
 │                  │                │          │              │
 │                  │ 分析交互        │          │              │
 │                  │────────────────┼─────────>│              │
 │                  │                │          │              │
 │                  │    交互分析结果  │          │              │
 │                  │<───────────────┼──────────│              │
 │                  │                │          │              │
 │                  │ 设计测试场景    │          │              │
 │                  │────────────────┼──────────┼─────────────>│
 │                  │                │          │              │
 │                  │    测试场景     │          │              │
 │                  │<───────────────┼──────────┼──────────────│
 │                  │                │          │              │
 │                  │ 解析结果        │          │              │
 │                  │────────────────┤          │              │
 │                  │                │          │              │
 │   分析结果        │                │          │              │
 │<─────────────────│                │          │              │
 │                  │                │          │              │
```

## 文件组织结构

```
autogenTest/
├── backend/
│   ├── config.py                          # 配置管理 (已更新)
│   ├── examples/
│   │   ├── llms.py                        # 模型客户端管理 (新建)
│   │   ├── image_analyzer.py              # 图片分析团队 (新建)
│   │   ├── image_analyzer_example.py      # 使用示例 (新建)
│   │   ├── test_image_analyzer.py         # 测试脚本 (新建)
│   │   ├── README_IMAGE_ANALYZER.md       # 详细文档 (新建)
│   │   ├── QUICK_START_IMAGE_ANALYZER.md  # 快速开始 (新建)
│   │   └── ARCHITECTURE.md                # 架构文档 (本文档)
│   └── prompts/
│       ├── prompt_loader.py               # 提示词加载器 (已更新)
│       ├── ui_expert.txt                  # UI 专家提示词 (新建)
│       ├── interaction_analyst.txt        # 交互分析师提示词 (新建)
│       └── test_scenario_expert.txt       # 测试场景专家提示词 (新建)
└── docs/
    ├── UI_IMAGE_ANALYZER_IMPLEMENTATION.md  # 实现文档 (新建)
    └── UI图片分析智能体团队完成.md           # 完成总结 (新建)
```

## 核心组件说明

### 1. ImageAnalyzerTeam (核心类)
- **职责**: 管理整个图片分析流程
- **特点**: 
  - 支持同步和流式分析
  - 自动管理团队成员
  - 结构化输出结果

### 2. 智能体团队
- **UI 专家**: 视觉和布局分析
- **交互分析师**: 交互行为分析
- **测试场景专家**: 测试场景设计

### 3. 模型客户端管理 (llms.py)
- **功能**: 统一管理多种模型客户端
- **特点**: 
  - 全局缓存
  - 自动配置
  - 模型家族识别

### 4. 配置系统
- **config.py**: 集中管理所有配置
- **prompts/**: 提示词文件管理
- **.env**: 环境变量配置

## 扩展点

### 1. 添加新智能体
在 `_create_team_members()` 方法中添加新的 AssistantAgent

### 2. 自定义工作流
修改 `_create_team()` 方法，使用不同的团队协作模式

### 3. 自定义终止条件
在 `_create_team()` 中修改 termination_condition

### 4. 自定义提示词
编辑 `backend/prompts/*.txt` 文件

### 5. 添加后处理
在 `_parse_analysis_results()` 中添加自定义逻辑

## 性能考虑

### 1. 客户端缓存
- 全局缓存避免重复创建
- 支持手动重置缓存

### 2. 流式输出
- 实时获得分析结果
- 提升用户体验

### 3. 批量处理
- 重用团队实例
- 减少初始化开销

## 安全考虑

### 1. API 密钥管理
- 使用环境变量
- 不在代码中硬编码

### 2. 输入验证
- 验证图片路径
- 检查文件大小

### 3. 错误处理
- 完善的异常处理
- 详细的错误日志

## 总结

这是一个设计良好、模块化的 UI 图片分析系统，具有以下特点：

✅ **清晰的分层架构**
✅ **灵活的扩展性**
✅ **完善的错误处理**
✅ **高效的性能优化**
✅ **丰富的文档支持**

系统可以轻松集成到现有项目中，并根据需求进行定制和扩展。

