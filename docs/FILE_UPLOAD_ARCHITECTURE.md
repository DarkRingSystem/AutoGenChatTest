# 文件上传功能架构说明

## 🏗️ 架构概览

文件上传功能采用**前后端职责分离**的设计，前端负责文件上传和状态显示，后端负责文件解析和上下文构建。

## 📊 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户操作                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    1. 前端：上传文件                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ • 用户选择文件（拖拽或点击）                              │  │
│  │ • 前端校验：大小（100MB）、数量（10个）、格式            │  │
│  │ • 显示文件列表                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              2. 前端：调用批量转换 API                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ POST /api/convert/markdown/batch                          │  │
│  │ FormData:                                                 │  │
│  │   - files: [file1, file2, ...]                           │  │
│  │   - max_concurrent: 3                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              3. 后端：解析文件并生成 ID                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ • 校验文件大小和数量                                      │  │
│  │ • 使用 marker 库解析文件                                  │  │
│  │ • 生成唯一文件 ID (UUID)                                  │  │
│  │ • 存储文件内容到内存：                                    │  │
│  │   file_storage[file_id] = {                              │  │
│  │     "filename": "xxx.pdf",                               │  │
│  │     "markdown": "...",                                   │  │
│  │     "metadata": {...}                                    │  │
│  │   }                                                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              4. 后端：返回解析结果                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Response:                                                 │  │
│  │ {                                                         │  │
│  │   "total": 2,                                            │  │
│  │   "success_count": 2,                                    │  │
│  │   "failed_count": 0,                                     │  │
│  │   "results": [                                           │  │
│  │     {                                                     │  │
│  │       "success": true,                                   │  │
│  │       "file_id": "uuid-123",  ← 文件 ID                  │  │
│  │       "filename": "file1.pdf",                           │  │
│  │       "markdown": "...",                                 │  │
│  │       ...                                                 │  │
│  │     },                                                    │  │
│  │     ...                                                   │  │
│  │   ]                                                       │  │
│  │ }                                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              5. 前端：保存文件 ID                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ parsedFiles = [                                           │  │
│  │   {                                                       │  │
│  │     uid: "local-uid",                                    │  │
│  │     name: "file1.pdf",                                   │  │
│  │     success: true,                                       │  │
│  │     file_id: "uuid-123"  ← 保存文件 ID                   │  │
│  │   },                                                      │  │
│  │   ...                                                     │  │
│  │ ]                                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              6. 用户输入问题并发送                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ • 用户输入："总结一下文件内容"                            │  │
│  │ • 前端提取文件 ID 列表                                    │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              7. 前端：调用聊天 API                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ POST /api/chat/stream (或 /api/team-chat/stream)         │  │
│  │ Body:                                                     │  │
│  │ {                                                         │  │
│  │   "message": "总结一下文件内容",                          │  │
│  │   "file_ids": ["uuid-123", "uuid-456"]  ← 文件 ID 列表   │  │
│  │ }                                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              8. 后端：构建文件上下文                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ def _build_message_with_file_context():                  │  │
│  │   # 从 file_storage 获取文件内容                         │  │
│  │   for file_id in file_ids:                               │  │
│  │     file_data = file_storage[file_id]                    │  │
│  │     file_contexts.append(                                │  │
│  │       f"### 文件: {filename}\n\n{markdown}"              │  │
│  │     )                                                     │  │
│  │                                                           │  │
│  │   # 构建完整消息                                          │  │
│  │   full_message = f"""                                    │  │
│  │   请结合以下文件内容和用户问题进行解答：                  │  │
│  │                                                           │  │
│  │   {file_contexts}                                        │  │
│  │                                                           │  │
│  │   ---                                                     │  │
│  │                                                           │  │
│  │   用户问题：{message}                                     │  │
│  │   """                                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              9. 后端：传递给智能体                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ session.agent.run_stream(task=full_message)              │  │
│  │                                                           │  │
│  │ 智能体接收到的完整消息：                                  │  │
│  │ ┌────────────────────────────────────────────────────┐  │  │
│  │ │ 请结合以下文件内容和用户问题进行解答：              │  │  │
│  │ │                                                     │  │  │
│  │ │ ### 文件: file1.pdf                                │  │  │
│  │ │ [文件1的完整markdown内容...]                       │  │  │
│  │ │                                                     │  │  │
│  │ │ ---                                                 │  │  │
│  │ │                                                     │  │  │
│  │ │ ### 文件: file2.pdf                                │  │  │
│  │ │ [文件2的完整markdown内容...]                       │  │  │
│  │ │                                                     │  │  │
│  │ │ ---                                                 │  │  │
│  │ │                                                     │  │  │
│  │ │ 用户问题：总结一下文件内容                          │  │  │
│  │ └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              10. 智能体处理并返回结果                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ • 智能体基于文件内容和用户问题生成回复                    │  │
│  │ • 通过 SSE 流式返回给前端                                 │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 🔑 关键设计点

### 1. 职责分离

**前端职责**：
- ✅ 文件上传和校验
- ✅ 显示解析进度
- ✅ 保存文件 ID
- ✅ 传递文件 ID 给后端
- ❌ **不处理** markdown 内容
- ❌ **不构建** 上下文

**后端职责**：
- ✅ 文件解析和转换
- ✅ 生成文件 ID
- ✅ 存储文件内容
- ✅ 根据文件 ID 构建上下文
- ✅ 传递完整消息给智能体

### 2. 文件 ID 机制

- 后端解析成功后生成唯一 ID (UUID)
- 文件内容存储在后端内存中（生产环境应使用 Redis 或数据库）
- 前端只保存文件 ID，不保存 markdown 内容
- 发送消息时，前端传递文件 ID 列表
- 后端根据 ID 从存储中获取内容

### 3. 上下文构建

**完全在后端完成**：
```python
# 后端 API 路由
@router.post("/api/chat/stream")
async def chat_stream(request: ChatRequest):
    # 1. 构建包含文件上下文的消息
    message_with_context = _build_message_with_file_context(
        request.message, 
        request.file_ids
    )
    
    # 2. 传递给智能体
    async for event in session.agent.run_stream(task=message_with_context):
        yield event
```

### 4. 数据模型

**ChatRequest**：
```python
class ChatRequest(BaseModel):
    message: str  # 用户原始消息
    conversation_id: Optional[str]  # 会话 ID
    file_ids: Optional[list[str]]  # 文件 ID 列表（新增）
```

**BatchMarkdownConvertResponse**：
```python
{
    "total": 2,
    "success_count": 2,
    "failed_count": 0,
    "results": [
        {
            "success": true,
            "file_id": "uuid-123",  # 新增：文件 ID
            "filename": "file1.pdf",
            "markdown": "...",  # 仍然返回，但前端不使用
            ...
        }
    ]
}
```

## 🔄 完整流程示例

### 场景：用户上传 2 个 PDF 并提问

#### 步骤 1: 上传文件
```javascript
// 前端
const formData = new FormData();
formData.append('files', file1);
formData.append('files', file2);

const response = await fetch('/api/convert/markdown/batch', {
  method: 'POST',
  body: formData
});

const result = await response.json();
// result.results[0].file_id = "uuid-123"
// result.results[1].file_id = "uuid-456"
```

#### 步骤 2: 保存文件 ID
```javascript
// 前端
const parsedFiles = result.results.map(r => ({
  uid: generateLocalUid(),
  name: r.filename,
  success: r.success,
  file_id: r.file_id  // 只保存 ID
}));
```

#### 步骤 3: 发送消息
```javascript
// 前端
const fileIds = parsedFiles
  .filter(f => f.success && f.file_id)
  .map(f => f.file_id);

await fetch('/api/chat/stream', {
  method: 'POST',
  body: JSON.stringify({
    message: "总结这两个文件的内容",
    file_ids: fileIds  // ["uuid-123", "uuid-456"]
  })
});
```

#### 步骤 4: 后端构建上下文
```python
# 后端
def _build_message_with_file_context(message, file_ids):
    # 从存储获取内容
    file1_content = file_storage["uuid-123"]["markdown"]
    file2_content = file_storage["uuid-456"]["markdown"]
    
    # 构建完整消息
    full_message = f"""
    请结合以下文件内容和用户问题进行解答：
    
    ### 文件: file1.pdf
    {file1_content}
    
    ---
    
    ### 文件: file2.pdf
    {file2_content}
    
    ---
    
    用户问题：总结这两个文件的内容
    """
    
    return full_message
```

#### 步骤 5: 智能体处理
```python
# 后端
async for event in session.agent.run_stream(task=full_message):
    # 智能体基于完整上下文生成回复
    yield event
```

## ✨ 优势

1. **职责清晰**：前端专注 UI，后端专注业务逻辑
2. **安全性高**：文件内容不在前端传输，减少数据泄露风险
3. **性能优化**：前端不需要处理大量 markdown 文本
4. **易于维护**：上下文格式变更只需修改后端
5. **可扩展性**：后端可以添加更多上下文处理逻辑（如摘要、过滤等）

## 🔒 安全考虑

1. **文件存储**：
   - 当前使用内存存储（简单实现）
   - 生产环境应使用 Redis 或数据库
   - 设置过期时间，自动清理旧文件

2. **访问控制**：
   - 文件 ID 应与会话关联
   - 验证用户是否有权访问文件
   - 防止文件 ID 泄露

3. **大小限制**：
   - 前后端双重校验
   - 防止内存溢出

## 📝 总结

这个架构设计实现了**前后端职责分离**，前端只负责文件上传和 ID 传递，后端负责所有的上下文构建逻辑。这样的设计更加清晰、安全、易于维护。

