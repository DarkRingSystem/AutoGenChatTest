# 会话管理测试指南

## 📋 测试场景

### 场景 1: 普通对话模式会话复用

**步骤**:
1. 进入普通对话模式
2. 发送第一条消息："你好"
3. 观察后端日志，应该看到：
   ```
   📝 创建新会话: session_xxx (总会话数: 1)
   ```
4. 发送第二条消息："介绍一下 Python"
5. 观察后端日志，**不应该**看到"创建新会话"
6. 发送第三条消息："谢谢"
7. 观察后端日志，**不应该**看到"创建新会话"

**预期结果**:
- ✅ 只在第一条消息时创建会话
- ✅ 后续消息复用同一个会话
- ✅ 总会话数保持为 1

---

### 场景 2: 切换模式保持各自会话

**步骤**:
1. 进入普通对话模式
2. 发送消息："你好"（创建会话 A）
3. 观察后端日志：
   ```
   📝 创建新会话: session_A (总会话数: 1)
   ```
4. 切换到测试用例模式
5. 发送消息："为登录接口生成测试用例"（创建会话 B）
6. 观察后端日志：
   ```
   📝 创建新会话: session_B (总会话数: 2)
   ```
7. 切换回普通对话模式
8. 发送消息："继续"
9. 观察后端日志，**不应该**看到"创建新会话"（复用会话 A）
10. 再次切换到测试用例模式
11. 发送消息："继续"
12. 观察后端日志，**不应该**看到"创建新会话"（复用会话 B）

**预期结果**:
- ✅ 普通对话模式有自己的会话 A
- ✅ 测试用例模式有自己的会话 B
- ✅ 切换模式时不重置会话 ID
- ✅ 每个模式复用自己的会话
- ✅ 总会话数为 2

---

### 场景 3: 清空对话重置会话

**步骤**:
1. 进入普通对话模式
2. 发送消息："你好"（创建会话 A）
3. 观察后端日志：
   ```
   📝 创建新会话: session_A (总会话数: 1)
   ```
4. 发送消息："继续"（复用会话 A）
5. 点击"清空对话"按钮
6. 发送消息："新的对话"（创建会话 C）
7. 观察后端日志：
   ```
   📝 创建新会话: session_C (总会话数: 2)
   ```

**预期结果**:
- ✅ 清空对话后重置会话 ID
- ✅ 下次发送消息创建新会话
- ✅ 旧会话 A 仍然存在（总会话数为 2）

---

### 场景 4: 刷新浏览器重置所有会话

**步骤**:
1. 进入普通对话模式，发送消息（创建会话 A）
2. 切换到测试用例模式，发送消息（创建会话 B）
3. 观察后端日志，总会话数为 2
4. 刷新浏览器（F5 或 Cmd+R）
5. 进入普通对话模式，发送消息（创建会话 D）
6. 观察后端日志：
   ```
   📝 创建新会话: session_D (总会话数: 3)
   ```

**预期结果**:
- ✅ 刷新浏览器后前端状态重置
- ✅ 下次发送消息创建新会话
- ✅ 旧会话 A 和 B 仍然存在（总会话数为 3）

---

### 场景 5: 多模式并发会话

**步骤**:
1. 进入普通对话模式
2. 发送消息："你好"（创建会话 A）
3. 发送消息："继续"（复用会话 A）
4. 切换到测试用例模式
5. 发送消息："生成测试用例"（创建会话 B）
6. 发送消息："继续"（复用会话 B）
7. 切换回普通对话模式
8. 发送消息："继续"（复用会话 A）
9. 观察后端日志

**预期结果**:
- ✅ 总会话数为 2
- ✅ 普通对话模式的所有消息使用会话 A
- ✅ 测试用例模式的所有消息使用会话 B
- ✅ 两个模式的会话完全独立

---

## 🔍 后端日志说明

### 正常日志示例

```bash
# 第一次发送消息
📝 创建新会话: session_68c620d4729447c39a8ffae77155c89e (总会话数: 1)
INFO:     127.0.0.1:55963 - "POST /api/chat/stream HTTP/1.1" 200 OK

# 第二次发送消息（复用会话）
INFO:     127.0.0.1:55963 - "POST /api/chat/stream HTTP/1.1" 200 OK

# 第三次发送消息（复用会话）
INFO:     127.0.0.1:55963 - "POST /api/chat/stream HTTP/1.1" 200 OK
```

### 异常日志示例（问题）

```bash
# 每次都创建新会话（这是错误的！）
📝 创建新会话: session_xxx1 (总会话数: 1)
INFO:     127.0.0.1:55963 - "POST /api/chat/stream HTTP/1.1" 200 OK

📝 创建新会话: session_xxx2 (总会话数: 2)
INFO:     127.0.0.1:55963 - "POST /api/chat/stream HTTP/1.1" 200 OK

📝 创建新会话: session_xxx3 (总会话数: 3)
INFO:     127.0.0.1:55963 - "POST /api/chat/stream HTTP/1.1" 200 OK
```

---

## 🐛 调试技巧

### 前端调试

打开浏览器开发者工具（F12），查看 Console：

```javascript
// 应该看到这些日志
📝 Conversation ID: session_xxx
💾 保存会话 ID: session_xxx

// 后续请求应该使用相同的 ID
🔵 自动检测反馈信息: { isFeedback: false, currentConversationId: "session_xxx", targetAgent: null }
```

### 后端调试

查看后端终端输出：

```bash
# 启动服务
cd backend
source venv/bin/activate
python main.py

# 观察日志
📝 创建新会话: session_xxx (总会话数: 1)  # 第一次
# 后续请求不应该看到"创建新会话"
```

### 网络请求调试

在浏览器开发者工具的 Network 标签中：

1. 找到 `/api/chat/stream` 请求
2. 查看 Request Payload：
   ```json
   {
     "message": "你好",
     "conversation_id": "session_xxx",  // 应该有值
     "is_feedback": false
   }
   ```
3. 查看 Response Headers：
   ```
   X-Conversation-ID: session_xxx
   X-Session-ID: session_xxx
   ```

---

## ✅ 验收标准

- [ ] 场景 1: 普通对话模式会话复用 - 通过
- [ ] 场景 2: 切换模式保持各自会话 - 通过
- [ ] 场景 3: 清空对话重置会话 - 通过
- [ ] 场景 4: 刷新浏览器重置所有会话 - 通过
- [ ] 场景 5: 多模式并发会话 - 通过

---

## 📚 相关文件

- **后端会话管理**: `backend/services/session_service.py`
- **后端 API 路由**: `backend/api/routes.py`
- **前端会话状态**: `frontend/src/App.jsx` (第 103-125 行)
- **前端会话保存**: `frontend/src/App.jsx` (第 285-292 行)

---

## 🎯 总结

现在的会话管理机制：

1. **每个模式独立会话**: 普通对话、测试用例、图片分析各有自己的会话 ID
2. **会话复用**: 同一模式内的多次对话复用同一个会话
3. **会话隔离**: 不同模式的会话完全独立
4. **会话重置**: 只在清空对话或刷新浏览器时重置
5. **会话持久化**: 后端会话在 30 分钟内保持活跃

这种设计提供了最佳的用户体验，用户可以在不同模式间自由切换而不丢失对话上下文。

